<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QUESTSYSTEM ‚Äì Modulansicht</title>
  <meta name="description" content="QUESTSYSTEM Modulansicht ‚Äì rendert eine Markdown-Datei direkt aus dem Repository." />
  <style>
    :root{ --bg:#0b0f16; --fg:#e7eef7; --muted:#9fb0c6; --link:#9ad1ff; --border:#243047; --card:#0f1521; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--fg); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center; padding:12px 16px; background:rgba(8,10,18,.75); border-bottom:1px solid var(--border); backdrop-filter: blur(6px);}
    header .dot{font-size:18px}
    header a{color:var(--link); text-decoration:none}
    header a:hover{text-decoration:underline}
    .wrap{max-width:1100px; margin:20px auto; padding:0 16px 40px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px 20px; box-shadow:0 8px 32px rgba(0,0,0,.35)}
    #title{margin:8px 0 18px 0; font-size:22px; letter-spacing:.2px}
    #meta{color:var(--muted); font-size:13px; margin-bottom:14px}
    #content{min-height:40vh}
    #content h1,#content h2,#content h3{margin-top:1.6em}
    #content a{color:var(--link)}
    #content code{background:#0b1220; padding:.15em .35em; border-radius:6px}
    #content pre{background:#0b1220; padding:12px; border-radius:10px; overflow:auto}
    #notice{margin-top:18px; font-size:13px; color:var(--muted)}
    .err{color:#ffc2c2}
    details{margin-top:16px}
    summary{cursor:pointer; color:var(--muted)}
    .url-list code{display:block; padding:2px 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js" defer></script>
</head>
<body>
  <header>
    <div class="dot">üçÑ</div>
    <strong>QUESTSYSTEM</strong>
    <span style="opacity:.6">/ Modulansicht</span>
    <nav style="margin-left:auto; display:flex; gap:12px;">
      <a href="./index.html">Ring-√úbersicht</a>
      <a id="view-raw" target="_blank" rel="noopener">Raw MD</a>
      <a id="view-github" target="_blank" rel="noopener">Auf GitHub</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="card">
      <h1 id="title">Modul wird geladen ‚Ä¶</h1>
      <div id="meta">Quelle: <code id="src"></code></div>
      <article id="content" aria-live="polite"></article>
      <div id="notice">Bei 404 werden alternative Pfade probiert und es wird im Zielordner nach dem besten Match gesucht (case-insensitiv, Space-Normalisierung). Unten findest du eine Diagnose.</div>
      <details id="diag" style="display:none;">
        <summary>Diagnose: getestete URLs & Matches</summary>
        <div class="url-list" id="diag-list"></div>
      </details>
    </div>
  </main>

  <script>
    const OWNER="Quest42-coder", REPO="QUESTSYSTEM_PUBLIC", REF="main";

    const params = new URLSearchParams(location.search);
    const fileParam = params.get('file') || "";

    // DOM
    const titleEl=document.getElementById('title');
    const srcEl=document.getElementById('src');
    const content=document.getElementById('content');
    const aRaw=document.getElementById('view-raw');
    const aGH=document.getElementById('view-github');
    const diag=document.getElementById('diag');
    const diagList=document.getElementById('diag-list');

    // Helpers
    function encPath(p){ return p.split('/').map(encodeURIComponent).join('/'); }
    function ghBlob(p){ return `https://github.com/${OWNER}/${REPO}/blob/${REF}/${encPath(p)}`; }
    function apiContents(p){ return `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encPath(p)}?ref=${encodeURIComponent(REF)}`; }
    function addDiag(label, info){
      diag.style.display='';
      const line=document.createElement('code'); line.textContent = `${label} ${info}`;
      diagList.appendChild(line);
    }

    // Normalisiert Dateinamen: Trim, Zero-Width raus, mehrere Spaces ‚Üí 1, ‚ÄûModul _‚Äú ‚Üí ‚ÄûModul_‚Äú, alles lower
    function normalizeName(name){
      return name
        .replace(/[\u200B-\u200D\uFEFF]/g,'')   // zero-width
        .replace(/\s+_/g,'_').replace(/_\s+/g,'_')
        .replace(/\s{2,}/g,' ')                 // mehrfach-Space
        .trim()
        .toLowerCase();
    }

    function getDirAndBase(p){
      const clean = p.replace(/^\.?\//,'');
      const parts = clean.split('/');
      const base = parts.pop();
      const dir  = parts.join('/');
      return {dir, base};
    }

    async function fetchViaContentsAPI(path){
      const url = apiContents(path);
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok){ addDiag('API:', `${res.status} ${url}`); return null; }
        const json = await res.json();
        if(!json.download_url){ addDiag('API:', `no download_url for ${url}`); return null; }
        addDiag('API:', `OK ${url}`);
        const rawURL = json.download_url;
        const rawRes = await fetch(rawURL, {cache:'no-store'});
        if(!rawRes.ok){ addDiag('RAW:', `${rawRes.status} ${rawURL}`); return null; }
        addDiag('RAW:', `OK ${rawURL}`);
        return { md: await rawRes.text(), chosenPath: path, rawURL };
      }catch(e){
        addDiag('API:', `ERR ${url}`);
        return null;
      }
    }

    async function tryDirectThenMatch(originalPath){
      // 1) Direkter Versuch
      const direct = await fetchViaContentsAPI(originalPath);
      if (direct) return direct;

      // 2) Pfadvarianten (Root/MODULES/modules/docs)
      const clean = originalPath.replace(/^\.?\//,'');
      const only  = clean.split('/').pop();
      const variants = Array.from(new Set([
        clean,
        `MODULES/${only}`,
        `modules/${only}`,
        `docs/${only}`,
        `docs/MODULES/${only}`,
      ]));

      for (const v of variants){
        const r = await fetchViaContentsAPI(v);
        if (r) return r;
      }

      // 3) Fallback: Ordnerinhalt listen und bestes Match suchen
      const {dir, base} = getDirAndBase(clean);
      const dirsToScan = Array.from(new Set([
        dir || 'MODULES',     // wenn kein Ordner angegeben war ‚Üí MODULES
        'MODULES',
        'modules'
      ]));

      const normTarget = normalizeName(base);
      for (const d of dirsToScan){
        const listURL = apiContents(d);
        try{
          const res = await fetch(listURL, {cache:'no-store'});
          if (!res.ok){ addDiag('LIST:', `${res.status} ${listURL}`); continue; }
          const arr = await res.json();
          if (!Array.isArray(arr)){ addDiag('LIST:', `not array ${listURL}`); continue; }
          addDiag('LIST:', `OK ${listURL}`);

          // Versuche exakten Treffer (case-insensitiv + normalisiert)
          let pick = arr.find(it => normalizeName(it.name) === normTarget);

          // Sonst: lockereres Matching (enth√§lt)
          if (!pick){
            pick = arr.find(it => normalizeName(it.name).includes(normTarget));
          }

          if (pick && pick.download_url){
            addDiag('MATCH:', `‚Üí ${d}/${pick.name}`);
            const rawRes = await fetch(pick.download_url, {cache:'no-store'});
            if(rawRes.ok){
              addDiag('RAW:', `OK ${pick.download_url}`);
              return { md: await rawRes.text(), chosenPath: `${d}/${pick.name}`, rawURL: pick.download_url };
            }else{
              addDiag('RAW:', `${rawRes.status} ${pick.download_url}`);
            }
          }
        }catch(e){
          addDiag('LIST:', `ERR ${listURL}`);
        }
      }
      return null;
    }

    async function load(){
      if(!fileParam){
        titleEl.textContent="Kein Modul angegeben";
        content.innerHTML = `<p class="err">Parameter fehlt: <code>?file=DATEINAME.md</code><br>z. B. <code>module.html?file=MODULES/Modul_32_LICENCE.md</code></p>`;
        return;
      }

      addDiag('INFO:', `requested="${fileParam}"`);

      const result = await tryDirectThenMatch(fileParam);

      if(!result){
        titleEl.textContent = "Fehler beim Laden";
        const firstBlob = ghBlob(fileParam.replace(/^\.?\//,''));
        srcEl.textContent = fileParam;
        aRaw.removeAttribute('href'); aGH.href = firstBlob;
        content.innerHTML = `
          <p class="err">Die Datei <code>${fileParam}</code> konnte nicht gefunden werden ‚Äì auch nach Matching-Versuch.</p>
          <p>Pr√ºfe bitte:
            <br>‚Ä¢ Exakter Dateiname und Gro√ü/Kleinschreibung
            <br>‚Ä¢ Versehentliche Spaces/Zero-Width-Zeichen (z. B. ‚ÄûModul _‚Äú)
            <br>‚Ä¢ Branch (<code>${REF}</code>)
          </p>
          <p>GitHub-Ansicht: <a href="${firstBlob}" target="_blank" rel="noopener">${firstBlob}</a></p>`;
        return;
      }

      const { md, chosenPath, rawURL } = result;

      // UI-Links + Quelle
      srcEl.textContent = chosenPath;
      aRaw.href = rawURL;
      aGH.href  = ghBlob(chosenPath);

      // Titel aus H1, sonst Dateiname
      const m = md.match(/^#\s+(.+)$/m);
      titleEl.textContent = m ? m[1].trim() : chosenPath.replace(/\.md$/,'').replace(/_/g,' ');

      const html = marked.parse(md, { mangle:false, headerIds:true });
      const safe = DOMPurify.sanitize(html, { USE_PROFILES:{ html:true } });
      content.innerHTML = safe;

      // relative Links ‚Üí GitHub-Blob
      content.querySelectorAll('a[href]').forEach(a=>{
        const href=a.getAttribute('href'); if(!href) return;
        const abs=/^https?:\/\//i.test(href)||href.startsWith('#')||href.startsWith('mailto:');
        if(abs) return;
        const normalized = href.replace(/^\.\//,'').replace(/^\//,'');
        a.setAttribute('href', ghBlob(normalized));
        a.setAttribute('target','_blank'); a.setAttribute('rel','noopener');
      });
    }

    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', load); else load();
  </script>
</body>
</html>
