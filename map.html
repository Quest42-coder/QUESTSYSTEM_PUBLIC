<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QUESTSYSTEM ‚Äì Modul-Map (V7.3)</title>
<meta name="description" content="Interaktive Ring-Map des QUESTSYSTEMS mit externen Labels, Leader-Lines und Hover-Verbindungen." />
<style>
  :root{
    --bg:#0a0f17; --fg:#eaf2ff; --muted:#9fb0c6; --border:#1f2a3d; --glass:rgba(14,18,28,.6);
    --q1:#79e1ff; --q2:#8affc7; --q3:#b09bff;
    --inner:#f3c0c7; --mid:#f0de94; --outer:#bcd5ff; --center:#9fe3ff;
    --node-bg:#0e1422; --node-stroke:#2b3550; --node-text:#e6efff;
    --shadow: 0 10px 28px rgba(0,0,0,.45);
    --header-h:58px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font:16px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background:
      radial-gradient(1400px 900px at 50% 38%, #121a2e 0%, #101726 55%, var(--bg) 100%),
      radial-gradient(900px 700px at 12% 14%, rgba(255,255,255,.05), transparent 60%),
      radial-gradient(900px 900px at 88% 84%, rgba(255,255,255,.035), transparent 65%);
    overflow:hidden;
  }

  /* Header */
  header{
    position:fixed; inset:0 0 auto 0; height:var(--header-h); z-index:80;
    display:flex; align-items:center; gap:12px; padding:8px 12px;
    background:var(--glass); border-bottom:1px solid var(--border); backdrop-filter: blur(8px);
  }
  .brand{ color:var(--fg); text-decoration:none; font-weight:900; letter-spacing:.3px; font-size:15px }
  nav{ margin-left:auto; display:flex; gap:10px; align-items:center }
  .dd{ position:relative }
  .dd>button{
    color:var(--fg); background:transparent; border:1px solid var(--border);
    padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700
  }
  .menu{
    position:absolute; right:0; top:calc(100% + 8px); min-width:240px; max-height:60vh; overflow:auto;
    display:none; flex-direction:column; gap:4px; padding:10px;
    background:rgba(10,13,20,.98); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
  }
  .dd:hover .menu{ display:flex }
  .menu a{ color:var(--fg); text-decoration:none; padding:9px 11px; border-radius:8px }
  .menu a:hover{ background:rgba(255,255,255,.07) }

  /* B√ºhne */
  .stage{ position:absolute; inset:var(--header-h) 0 0 0; display:grid; place-items:center; }
  svg{ width:min(1300px, 96vw); height:min(1300px, calc(96vh - var(--header-h))); }

  /* Gradients */
  defs linearGradient stop{ transition:all .2s ease }

  /* Ringe */
  .ring{ fill:none; stroke-opacity:.9; }
  .ring.inner{ stroke:var(--inner); stroke-width:2.2 }
  .ring.mid{   stroke:var(--mid);   stroke-width:2.2 }
  .ring.outer{ stroke:var(--outer); stroke-width:2.2 }

  /* Verbindungen */
  .links line{
    stroke:url(#qgrad); stroke-opacity:.95; stroke-width:2.6;
    filter: drop-shadow(0 0 10px rgba(121,225,255,.35));
  }
  .links.hidden{ opacity:0; pointer-events:none }
  .links.visible{ opacity:1; transition: opacity .12s ease }

  /* Nodes √ºber Ringen (Durchbrechung) */
  g.nodes{ filter: drop-shadow(0 2px 10px rgba(0,0,0,.45)); }

  /* Knoten */
  a.node{ cursor:pointer; transition: transform .12s ease, opacity .12s ease; }
  a.node:hover{ transform: translateY(-1px) scale(1.02); }
  .node circle{
    fill:var(--node-bg); stroke:var(--node-stroke); stroke-width:1.9;
  }
  .node circle.glow{ fill:none; stroke:rgba(255,255,255,.16); stroke-width:6; opacity:.65; filter:blur(1.5px); }
  .node.active circle{ stroke:url(#qgrad); stroke-width:2.8; }
  .node.linked circle{ stroke:url(#qgrad); stroke-width:2.5; opacity:.95; }

  /* Zentrum */
  .center circle.core{ fill:transparent; stroke:#6b7a90; stroke-dasharray:4 6; stroke-width:2; }
  .center a.node text{ fill:#cceaff; font-size:20px; font-weight:1000 }
  .center a.node circle{ fill:rgba(20,28,44,.7); stroke:url(#qgrad); stroke-width:2.8 }

  /* Externe Labels + Leader-Lines */
  .label text{
    fill:var(--fg); font-weight:900; letter-spacing:.35px; font-size:15px;
    paint-order: stroke; stroke: rgba(10,15,24,.75); stroke-width:4px; /* Kontur f√ºr Lesbarkeit */
  }
  .label line{
    stroke:#a8c7ff; stroke-opacity:.8; stroke-width:1.6;
  }
  .label.active text{ fill:#04121a; stroke:none }
  .label.active rect{ fill:url(#qgrad) }
  .label rect{
    fill:rgba(12,18,32,.8); stroke:1px solid #22314a; rx:7; ry:7;
  }

  /* Legende */
  .legend{
    position:fixed; inset:auto 12px 12px 12px; z-index:70;
    display:flex; gap:10px; align-items:center; justify-content:center;
    background:rgba(12,16,24,.55); border:1px solid var(--border); border-radius:10px; padding:8px 10px; backdrop-filter: blur(6px);
  }
  .chip{display:inline-flex; align-items:center; gap:8px; font-size:12px}
  .sw{width:14px; height:14px; border-radius:50%}
  .sw.center{background:var(--center)}
  .sw.inner{background:var(--inner)}
  .sw.mid{background:var(--mid)}
  .sw.outer{background:var(--outer)}

  /* Tooltip */
  .tip{
    position:fixed; z-index:90; pointer-events:none;
    transform:translate(-50%, calc(-100% - 12px));
    background:#0f1624; border:1px solid #2b3548; color:var(--fg);
    padding:8px 10px; border-radius:8px; font-size:12px; white-space:nowrap;
    opacity:0; transition:opacity .12s ease, transform .12s ease; box-shadow: var(--shadow);
  }
  .tip.show{ opacity:1; transform:translate(-50%, calc(-100% - 10px)) }
  .tip small{ color:var(--muted) }
</style>
</head>
<body>
<header aria-label="Seitennavigation">
  <a class="brand" href="./index.html">üçÑ QUESTSYSTEM</a>
  <nav>
    <div class="dd">
      <button>System</button>
      <div class="menu">
        <a href="./index.html">Start</a>
        <a href="./map.html">Modul-Map</a>
        <a href="module.html?file=ARTIST_PROFILE.md">Artist Profile</a>
        <a href="module.html?file=MODULES/Modul_32_LICENCE.md">Licence</a>
        <a href="https://github.com/Quest42-coder/QUESTSYSTEM_PUBLIC" target="_blank" rel="noopener">Repository</a>
      </div>
    </div>
    <div class="dd">
      <button>Ethik</button>
      <div class="menu">
        <a href="module.html?file=Dignity_Clause.md">Dignity Clause</a>
        <a href="module.html?file=14_GEBOTE_V2.1.md">14 Gebote (V2.1)</a>
        <a href="module.html?file=14_GEBOTE_DISCUSSION.md">Diskussion</a>
      </div>
    </div>
    <div class="dd">
      <button>Module</button>
      <div class="menu" id="menu-mods"></div>
    </div>
  </nav>
</header>

<div class="stage">
  <svg id="map" viewBox="-660 -660 1320 1320"
       xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
       role="img" aria-label="Konzentrische Modul-Ringe des QUESTSYSTEMS">
    <defs>
      <linearGradient id="qgrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%"  stop-color="var(--q1)"/>
        <stop offset="50%" stop-color="var(--q2)"/>
        <stop offset="100%" stop-color="var(--q3)"/>
      </linearGradient>
    </defs>

    <!-- Ringe -->
    <g class="rings">
      <circle class="ring inner" r="220"></circle>
      <circle class="ring mid"   r="380"></circle>
      <circle class="ring outer" r="540"></circle>
    </g>

    <!-- Verbindungen -->
    <g class="links hidden" id="links-layer"></g>

    <!-- Zentrum -->
    <g class="center">
      <circle class="core" r="90"></circle>
      <!-- RESETBOX Node + Label via JS -->
    </g>

    <!-- Nodes (√ºber Ringen) -->
    <g class="nodes" id="nodes-layer"></g>

    <!-- Labels separat (oberste Ebene) -->
    <g class="labels" id="labels-layer"></g>
  </svg>
</div>

<div class="legend" aria-hidden="true">
  <span class="chip"><span class="sw center"></span>RESETBOX</span>
  <span class="chip"><span class="sw inner"></span>Existential</span>
  <span class="chip"><span class="sw mid"></span>Societal</span>
  <span class="chip"><span class="sw outer"></span>Structural</span>
</div>

<div id="tip" class="tip" role="status" aria-live="polite"></div>

<script>
/* ===== Daten ===== */
const MODS = [
  {no:"01", id:"RESETBOX", ring:"center", file:"MODULES/Modul_01_RESETBOX.md"},
  {no:"02", id:"WATER",   ring:"inner", file:"MODULES/Modul_02_WATER.md"},
  {no:"03", id:"SHELTER", ring:"inner", file:"MODULES/Modul_03_SHELTER.md"},
  {no:"04", id:"FOOD",    ring:"inner", file:"MODULES/Modul_04_FOOD.md"},
  {no:"05", id:"SLEEP",   ring:"inner", file:"MODULES/Modul_05_SLEEP.md"},
  {no:"06", id:"BODY",    ring:"inner", file:"MODULES/Modul_06_BODY.md"},
  {no:"07", id:"PSYCHE",  ring:"inner", file:"MODULES/Modul_07_PSYCHE.md"},
  {no:"08", id:"DEVICE",  ring:"inner", file:"MODULES/Modul_08_DEVICE.md"},
  {no:"09", id:"DEBT",    ring:"inner", file:"MODULES/Modul_09_DEBT.md"},
  {no:"10", id:"WORK",      ring:"mid", file:"MODULES/Modul_10_WORK.md"},
  {no:"11", id:"SCHOOL",    ring:"mid", file:"MODULES/Modul_11_SCHOOL.md"},
  {no:"12", id:"BORDER",    ring:"mid", file:"MODULES/Modul_12_BORDER.md"},
  {no:"13", id:"NATURE",    ring:"mid", file:"MODULES/Modul_13_NATURE.md"},
  {no:"14", id:"HEALTH",    ring:"mid", file:"MODULES/Modul_14_HEALTH.md"},
  {no:"15", id:"CARE",      ring:"mid", file:"MODULES/Modul_15_CARE.md"},
  {no:"16", id:"FAMILY",    ring:"mid", file:"MODULES/Modul_16_FAMILY.md"},
  {no:"17", id:"ANIMAL",    ring:"mid", file:"MODULES/Modul_17_ANIMAL.md"},
  {no:"18", id:"CULTURE",   ring:"mid", file:"MODULES/Modul_18_CULTURE.md"},
  {no:"19", id:"MEDIA",     ring:"mid", file:"MODULES/Modul_19_MEDIA.md"},
  {no:"20", id:"ENERGY",    ring:"mid", file:"MODULES/Modul_20_ENERGY.md"},
  {no:"21", id:"CLIMATE",   ring:"mid", file:"MODULES/Modul_21_CLIMATE.md"},
  {no:"22", id:"MIGRATION", ring:"mid", file:"MODULES/Modul_22_MIGRATION.md"},
  {no:"23", id:"JUSTICE",   ring:"mid", file:"MODULES/Modul_23_JUSTICE.md"},
  {no:"24", id:"COMMUNITY", ring:"mid", file:"MODULES/Modul_24_COMMUNITY.md"},
  {no:"25", id:"FINANCE",    ring:"outer", file:"MODULES/Modul_25_FINANCE.md"},
  {no:"26", id:"HOUSING",    ring:"outer", file:"MODULES/Modul_26_HOUSING.md"},
  {no:"27", id:"TRANSPORT",  ring:"outer", file:"MODULES/Modul_27_TRANSPORT.md"},
  {no:"28", id:"NETWORK",    ring:"outer", file:"MODULES/Modul_28_NETWORK.md"},
  {no:"29", id:"SYMBOL",     ring:"outer", file:"MODULES/Modul_29_SYMBOL.md"},
  {no:"30", id:"TRUTH",      ring:"outer", file:"MODULES/Modul_30_TRUTH.md"},
  {no:"31", id:"MEMORY",     ring:"outer", file:"MODULES/Modul_31_MEMORY.md"},
  {no:"32", id:"LICENCE",    ring:"outer", file:"MODULES/Modul_32_LICENCE.md"},
  {no:"33", id:"PRIVACY",    ring:"outer", file:"MODULES/Modul_33_PRIVACY.md"},
  {no:"34", id:"SECURITY",   ring:"outer", file:"MODULES/Modul_34_SECURITY.md"},
  {no:"35", id:"DATA",       ring:"outer", file:"MODULES/Modul_35_DATA.md"},
  {no:"36", id:"CONFLICT",   ring:"outer", file:"MODULES/Modul_36_CONFLICT.md"},
  {no:"37", id:"DEMOCRACY",  ring:"outer", file:"MODULES/Modul_37_DEMOCRACY.md"},
  {no:"38", id:"GOVERNANCE", ring:"outer", file:"MODULES/Modul_38_GOVERNANCE.md"},
  {no:"39", id:"KNOWLEDGE",  ring:"outer", file:"MODULES/Modul_39_KNOWLEDGE.md"},
  {no:"40", id:"ART",        ring:"outer", file:"MODULES/Modul_40_ART.md"},
  {no:"41", id:"FUTURE",     ring:"outer", file:"MODULES/Modul_41_FUTURE.md"},
  {no:"42", id:"DEATH",      ring:"outer", file:"MODULES/Modul_42_DEATH.md"},
];
const CORE = {
  "01:RESETBOX": ["02:WATER","03:SHELTER","09:DEBT"],
  "02:WATER":    ["04:FOOD","06:BODY","13:NATURE"],
  "03:SHELTER":  ["05:SLEEP","13:NATURE","01:RESETBOX"],
  "04:FOOD":     ["02:WATER","13:NATURE","25:FINANCE"],
  "05:SLEEP":    ["03:SHELTER","07:PSYCHE","06:BODY"],
  "06:BODY":     ["02:WATER","05:SLEEP","07:PSYCHE"],
  "07:PSYCHE":   ["05:SLEEP","06:BODY","30:TRUTH"],
  "08:DEVICE":   ["20:ENERGY","32:LICENCE","01:RESETBOX"],
  "09:DEBT":     ["10:WORK","25:FINANCE","01:RESETBOX"],

  "10:WORK":      ["09:DEBT","11:SCHOOL","25:FINANCE"],
  "11:SCHOOL":    ["10:WORK","30:TRUTH","07:PSYCHE"],
  "12:BORDER":    ["01:RESETBOX","13:NATURE","36:CONFLICT"],
  "13:NATURE":    ["02:WATER","04:FOOD","20:ENERGY"],
  "14:HEALTH":    ["02:WATER","06:BODY","07:PSYCHE"],
  "15:CARE":      ["14:HEALTH","07:PSYCHE","01:RESETBOX"],
  "16:FAMILY":    ["05:SLEEP","11:SCHOOL","14:HEALTH"],
  "17:ANIMAL":    ["04:FOOD","13:NATURE","14:HEALTH"],
  "18:CULTURE":   ["11:SCHOOL","30:TRUTH","29:SYMBOL"],
  "19:MEDIA":     ["30:TRUTH","32:LICENCE","11:SCHOOL"],
  "20:ENERGY":    ["08:DEVICE","13:NATURE","25:FINANCE"],
  "21:CLIMATE":   ["13:NATURE","20:ENERGY","14:HEALTH"],
  "22:MIGRATION": ["12:BORDER","13:NATURE","36:CONFLICT"],
  "23:JUSTICE":   ["09:DEBT","10:WORK","32:LICENCE"],
  "24:COMMUNITY": ["11:SCHOOL","18:CULTURE","23:JUSTICE"],

  "25:FINANCE":   ["09:DEBT","10:WORK","20:ENERGY"],
  "26:HOUSING":   ["03:SHELTER","05:SLEEP","25:FINANCE"],
  "27:TRANSPORT": ["02:WATER","20:ENERGY","22:MIGRATION"],
  "28:NETWORK":   ["08:DEVICE","20:ENERGY","19:MEDIA"],
  "29:SYMBOL":    ["18:CULTURE","24:COMMUNITY","30:TRUTH"],
  "30:TRUTH":     ["11:SCHOOL","19:MEDIA","32:LICENCE"],
  "31:MEMORY":    ["11:SCHOOL","29:SYMBOL","30:TRUTH"],
  "32:LICENCE":   ["19:MEDIA","30:TRUTH","08:DEVICE"],
  "33:PRIVACY":   ["08:DEVICE","19:MEDIA","32:LICENCE"],
  "34:SECURITY":  ["01:RESETBOX","12:BORDER","36:CONFLICT"],
  "35:DATA":      ["08:DEVICE","28:NETWORK","32:LICENCE"],
  "36:CONFLICT":  ["12:BORDER","22:MIGRATION","34:SECURITY"],
  "37:DEMOCRACY": ["23:JUSTICE","24:COMMUNITY","25:FINANCE"],
  "38:GOVERNANCE":["23:JUSTICE","37:DEMOCRACY","25:FINANCE"],
  "39:KNOWLEDGE": ["11:SCHOOL","30:TRUTH","31:MEMORY"],
  "40:ART":       ["18:CULTURE","29:SYMBOL","39:KNOWLEDGE"],
  "41:FUTURE":    ["21:CLIMATE","39:KNOWLEDGE","40:ART"],
  "42:DEATH":     ["14:HEALTH","15:CARE","41:FUTURE"],
};

/* ===== Helpers ===== */
const SVG_NS="http://www.w3.org/2000/svg"; const XLINK_NS="http://www.w3.org/1999/xlink";
const R = { inner:220, mid:380, outer:540, center:0 };
const RS = { inner:46, mid:46, outer:46, center:78 }; // gr√∂√üere Kreise; RESETBOX prominent
function polar(r, a){ return [Math.cos(a)*r, Math.sin(a)*r]; }
function urlFor(filePath){
  const u = new URL(window.location.href);
  if (u.pathname.endsWith('map.html')) u.pathname = u.pathname.replace(/map\.html$/,'');
  if (!u.pathname.endsWith('/')) u.pathname += '/';
  return u.origin + u.pathname + 'module.html?file=' + encodeURIComponent(filePath);
}

/* Symmetrisierte Kanten */
const LINKS = new Map();
for (const [k, arr] of Object.entries(CORE)) {
  const a = k.split(':')[1];
  if (!LINKS.has(a)) LINKS.set(a, new Set());
  arr.forEach(bKey=>{
    const b = bKey.split(':')[1];
    if (!LINKS.has(b)) LINKS.set(b, new Set());
    LINKS.get(a).add(b); LINKS.get(b).add(a);
  });
}

/* ===== Build ===== */
const svg = document.getElementById('map');
const nodesLayer  = document.getElementById('nodes-layer');
const labelsLayer = document.getElementById('labels-layer');
const linksLayer  = document.getElementById('links-layer');
const tip = document.getElementById('tip');

/* Anti-Overlap: leichte Winkelspreizung, wenn benachbart zu dicht */
function distributeAngles(listLen){
  const step = (Math.PI*2)/listLen, start=-Math.PI/2;
  const angles = Array.from({length:listLen},(_,i)=>start+i*step);
  // sanfte Spreizung: pr√ºfe Nachbarn, addiere kleine Offsets
  const MIN_GAP = (Math.PI/180)*6; // 6¬∞
  for(let i=0;i<listLen;i++){
    const prev = angles[(i-1+listLen)%listLen], cur = angles[i], next = angles[(i+1)%listLen];
    if (cur-prev < MIN_GAP) angles[i]+= (MIN_GAP - (cur-prev))/2;
    if (next-cur < MIN_GAP) angles[i]-= (MIN_GAP - (next-cur))/2;
  }
  return angles;
}

function addNode(mod, ring, angle, r){
  const [x,y] = polar(r, angle);
  const a = document.createElementNS(SVG_NS,'a');
  a.classList.add('node', ring);
  a.setAttribute('href', urlFor(mod.file));
  a.setAttributeNS(XLINK_NS,'xlink:href', urlFor(mod.file));
  a.setAttribute('transform',`translate(${x},${y})`);
  a.dataset.id = mod.id;

  const glow = document.createElementNS(SVG_NS,'circle'); glow.setAttribute('r', RS[ring]); glow.setAttribute('class','glow'); a.appendChild(glow);
  const c = document.createElementNS(SVG_NS,'circle'); c.setAttribute('r', RS[ring]); a.appendChild(c);

  addNodeEvents(a, mod, {x,y,angle,ring});
  nodesLayer.appendChild(a);

  // Label au√üen
  addLabel(mod, ring, angle, r, {x,y});
}

function addLabel(mod, ring, angle, r, center){
  // Labelradius + Offset je Ring
  const offset = ring==='inner'? 72 : ring==='mid'? 78 : 84;
  const [lx,ly] = polar(r+offset, angle);

  const g = document.createElementNS(SVG_NS,'g');
  g.setAttribute('transform', `translate(${lx},${ly})`);
  g.setAttribute('class','label');
  g.dataset.id = mod.id;

  // Leader-Line
  const line = document.createElementNS(SVG_NS,'line');
  line.setAttribute('x1', 0); line.setAttribute('y1', 0);
  line.setAttribute('x2', center.x - lx); line.setAttribute('y2', center.y - ly);
  g.appendChild(line);

  // Hintergrund-Kapsel dynamisch
  const text = document.createElementNS(SVG_NS,'text');
  text.textContent = `${mod.no} ${mod.id}`;
  text.setAttribute('dominant-baseline','middle');

  // Text-Ausrichtung je Quadrant
  const deg = angle * 180/Math.PI;
  if (deg > -90 && deg <= 90){ // rechte Seite
    text.setAttribute('text-anchor','start');
    text.setAttribute('x', 10);
  } else { // linke Seite
    text.setAttribute('text-anchor','end');
    text.setAttribute('x', -10);
  }
  text.setAttribute('y', 0);

  // Hintergrund-Rect nach Text-BBox (nach minimaler Verz√∂gerung f√ºr korrekte BBox)
  const rect = document.createElementNS(SVG_NS,'rect');
  g.appendChild(rect); g.appendChild(text);
  labelsLayer.appendChild(g);

  requestAnimationFrame(()=>{ // warte, bis im DOM
    const bb = text.getBBox();
    rect.setAttribute('x', bb.x - 8);
    rect.setAttribute('y', bb.y - 4);
    rect.setAttribute('width', bb.width + 16);
    rect.setAttribute('height', bb.height + 8);
  });
}

function buildMap(){
  // Center (RESETBOX)
  const m0 = MODS.find(m=>m.ring==='center');
  addNode(m0, 'center', 0, 0); // angle/r ignoriert
  // √ºberschreibe Position exakt im Zentrum:
  const centerNode = nodesLayer.querySelector('a.node.center');
  centerNode.setAttribute('transform','translate(0,0)');

  // Label f√ºr RESETBOX zentral, ohne Leader
  const g = document.createElementNS(SVG_NS,'g');
  g.setAttribute('transform','translate(0,0)');
  g.setAttribute('class','label active');
  g.dataset.id = m0.id;
  const rect = document.createElementNS(SVG_NS,'rect'); g.appendChild(rect);
  const text = document.createElementNS(SVG_NS,'text');
  text.textContent = `01 ${m0.id}`; text.setAttribute('text-anchor','middle'); text.setAttribute('y','0');
  text.setAttribute('dominant-baseline','middle');
  g.appendChild(text);
  labelsLayer.appendChild(g);
  requestAnimationFrame(()=>{
    const bb = text.getBBox();
    rect.setAttribute('x', bb.x - 10); rect.setAttribute('y', bb.y - 6);
    rect.setAttribute('width', bb.width + 20); rect.setAttribute('height', bb.height + 12);
  });

  // Gruppen
  const byRing = {inner:[], mid:[], outer:[]};
  MODS.forEach(m=>{ if(m.ring!=='center') byRing[m.ring].push(m); });

  // Platzieren mit sanfter Anti-Overlap-Spreizung
  for(const ring of ['inner','mid','outer']){
    const list = byRing[ring];
    const angles = distributeAngles(list.length);
    list.forEach((m,i)=> addNode(m, ring, angles[i], R[ring]));
  }
}

/* ===== Interaktion ===== */
function nodeCenterPos(nodeEl){
  const tr = nodeEl.getAttribute('transform');
  const m = tr && tr.match(/translate\(([-\d.]+),([-\d.]+)\)/);
  return m ? {x:parseFloat(m[1]), y:parseFloat(m[2])} : {x:0,y:0};
}

function setLabelActive(id, on){
  const label = labelsLayer.querySelector(`.label[data-id="${id}"]`);
  if(!label) return;
  if(on) label.classList.add('active'); else label.classList.remove('active');
}

function highlight(id){
  document.querySelectorAll('a.node').forEach(n => n.classList.remove('active','linked'));
  const active = Array.from(document.querySelectorAll('a.node')).find(n => n.dataset.id === id);
  if (active) active.classList.add('active');

  setLabelActive(id, true);

  const targets = Array.from(LINKS.get(id) || []);
  const targetEls = [];
  targets.forEach(tid=>{
    const el = Array.from(document.querySelectorAll('a.node')).find(n => n.dataset.id === tid);
    if(el){ el.classList.add('linked'); targetEls.push(el); }
    setLabelActive(tid, true);
  });

  // Linien neu aufbauen
  while (linksLayer.firstChild) linksLayer.removeChild(linksLayer.firstChild);
  if (active && targetEls.length){
    const pA = nodeCenterPos(active);
    targetEls.forEach(el=>{
      const pB = nodeCenterPos(el);
      const line = document.createElementNS(SVG_NS,'line');
      line.setAttribute('x1', pA.x); line.setAttribute('y1', pA.y);
      line.setAttribute('x2', pB.x); line.setAttribute('y2', pB.y);
      linksLayer.appendChild(line);
    });
    linksLayer.classList.remove('hidden'); linksLayer.classList.add('visible');
  }else{
    linksLayer.classList.remove('visible'); linksLayer.classList.add('hidden');
  }
}

function clearHighlight(){
  document.querySelectorAll('a.node').forEach(n => n.classList.remove('active','linked'));
  labelsLayer.querySelectorAll('.label').forEach(l => l.classList.remove('active'));
  while (linksLayer.firstChild) linksLayer.removeChild(linksLayer.firstChild);
  linksLayer.classList.remove('visible'); linksLayer.classList.add('hidden');
}

function addNodeEvents(anchor, mod, meta){
  // Tooltip
  anchor.addEventListener('mouseenter', (e)=>{
    tip.innerHTML = `${mod.no} ${mod.id}<br><small>√ñffnen</small>`;
    tip.style.left = e.clientX+'px'; tip.style.top = e.clientY+'px';
    tip.classList.add('show');
    highlight(mod.id);
  });
  anchor.addEventListener('mousemove', (e)=>{ tip.style.left = e.clientX+'px'; tip.style.top = e.clientY+'px'; });
  anchor.addEventListener('mouseleave', ()=>{
    tip.classList.remove('show');
    clearHighlight();
  });
}

/* ===== Header: Module-Men√º ===== */
(function fillMenu(){
  const menu = document.getElementById('menu-mods');
  MODS.forEach(m=>{
    const a = document.createElement('a');
    a.href = 'module.html?file=' + encodeURIComponent(m.file);
    a.textContent = `${m.no} ${m.id}`;
    menu.appendChild(a);
  });
})();

/* ===== Init ===== */
buildMap();
</script>
</body>
</html>
