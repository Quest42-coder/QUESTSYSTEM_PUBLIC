<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QUESTSYSTEM – Map Debug</title>
<style>
  body{margin:0;background:#0e1116;color:#e7eef7;font:14px/1.5 system-ui,Arial}
  .stage{position:fixed;inset:0;display:grid;place-items:center;padding:8px}
  svg{width:min(1200px,95vw);height:min(1200px,95vh);background:#0a0f18}
  .ring{fill:none;stroke-width:2.6}
  .ring.inner{stroke:#ff6f86}
  .ring.mid{stroke:#e1c94d}
  .ring.outer{stroke:#7cb0ff}
  .center circle{fill:transparent;stroke:#87a6c8;stroke-dasharray:4 6;stroke-width:2.6}
  /* Nodes */
  a.node .glow{fill:none;stroke:rgba(255,255,255,.22);stroke-width:9;opacity:.8}
  a.node circle{fill:#101826;stroke:#3b527c;stroke-width:2.2}
  a.node{cursor:pointer}
  /* Links (nur bei Hover sichtbar) */
  .links path{stroke:#51e2ff;stroke-width:3.4;fill:none;opacity:0;filter: drop-shadow(0 0 14px rgba(81,226,255,.4))}
  .links.visible path{opacity:1}
  /* Labels */
  .label text{font-weight:800;fill:#dfeaff;paint-order:stroke;stroke:#0a0f18;stroke-width:5px}
  .label.active text{fill:#06131c;stroke:none}
  .label rect{fill:#dfeaff;rx:8;ry:8}
  /* Tooltip + Diagnose */
  .tip{position:fixed;pointer-events:none;left:0;top:0;background:#0f1624;color:#fff;
       border:1px solid #30405a;border-radius:8px;padding:6px 8px;opacity:0;transition:.12s}
  .tip.show{opacity:1;transform:translateY(-2px)}
  .diag{position:fixed;left:10px;bottom:10px;background:#222;color:#fff;border-radius:8px;padding:6px 8px;font:12px ui-monospace,monospace}
</style>
</head>
<body>
<div class="stage">
  <svg id="map" viewBox="-700 -700 1400 1400"
       xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g class="rings">
      <circle class="ring inner" r="220"></circle>
      <circle class="ring mid"   r="380"></circle>
      <circle class="ring outer" r="540"></circle>
    </g>
    <g class="links" id="links-layer"></g>
    <g class="center"><circle r="100"></circle></g>
    <g class="nodes" id="nodes-layer"></g>
    <g class="labels" id="labels-layer"></g>
  </svg>
</div>
<div class="tip" id="tip"></div>
<div class="diag" id="diag">boot…</div>

<script>
(function(){
  // --- harte Defaults (unabhängig von CSS-Variablen) ---
  var RS={inner:56,mid:56,outer:56,center:96};
  var R={inner:220,mid:380,outer:540,center:0};

  // --- Module + Dateien (Root/MODULES) ---
  var MODS=[
    {no:"01",id:"RESETBOX", ring:"center", file:"MODULES/Modul_01_RESETBOX.md"},
    {no:"02",id:"WATER",    ring:"inner",  file:"MODULES/Modul_02_WATER.md"},
    {no:"03",id:"SHELTER",  ring:"inner",  file:"MODULES/Modul_03_SHELTER.md"},
    {no:"04",id:"FOOD",     ring:"inner",  file:"MODULES/Modul_04_FOOD.md"},
    {no:"05",id:"SLEEP",    ring:"inner",  file:"MODULES/Modul_05_SLEEP.md"},
    {no:"06",id:"BODY",     ring:"inner",  file:"MODULES/Modul_06_BODY.md"},
    {no:"07",id:"PSYCHE",   ring:"inner",  file:"MODULES/Modul_07_PSYCHE.md"},
    {no:"08",id:"DEVICE",   ring:"inner",  file:"MODULES/Modul_08_DEVICE.md"},
    {no:"09",id:"DEBT",     ring:"inner",  file:"MODULES/Modul_09_DEBT.md"},
    {no:"10",id:"WORK",     ring:"mid",    file:"MODULES/Modul_10_WORK.md"},
    {no:"11",id:"SCHOOL",   ring:"mid",    file:"MODULES/Modul_11_SCHOOL.md"},
    {no:"12",id:"BORDER",   ring:"mid",    file:"MODULES/Modul_12_BORDER.md"},
    {no:"13",id:"NATURE",   ring:"mid",    file:"MODULES/Modul_13_NATURE.md"},
    {no:"14",id:"HEALTH",   ring:"mid",    file:"MODULES/Modul_14_HEALTH.md"},
    {no:"15",id:"CARE",     ring:"mid",    file:"MODULES/Modul_15_CARE.md"},
    {no:"16",id:"FAMILY",   ring:"mid",    file:"MODULES/Modul_16_FAMILY.md"},
    {no:"17",id:"ANIMAL",   ring:"mid",    file:"MODULES/Modul_17_ANIMAL.md"},
    {no:"18",id:"CULTURE",  ring:"mid",    file:"MODULES/Modul_18_CULTURE.md"},
    {no:"19",id:"MEDIA",    ring:"mid",    file:"MODULES/Modul_19_MEDIA.md"},
    {no:"20",id:"ENERGY",   ring:"mid",    file:"MODULES/Modul_20_ENERGY.md"},
    {no:"21",id:"CLIMATE",  ring:"mid",    file:"MODULES/Modul_21_CLIMATE.md"},
    {no:"22",id:"MIGRATION",ring:"mid",    file:"MODULES/Modul_22_MIGRATION.md"},
    {no:"23",id:"JUSTICE",  ring:"mid",    file:"MODULES/Modul_23_JUSTICE.md"},
    {no:"24",id:"COMMUNITY",ring:"mid",    file:"MODULES/Modul_24_COMMUNITY.md"},
    {no:"25",id:"FINANCE",  ring:"outer",  file:"MODULES/Modul_25_FINANCE.md"},
    {no:"26",id:"HOUSING",  ring:"outer",  file:"MODULES/Modul_26_HOUSING.md"},
    {no:"27",id:"TRANSPORT",ring:"outer",  file:"MODULES/Modul_27_TRANSPORT.md"},
    {no:"28",id:"NETWORK",  ring:"outer",  file:"MODULES/Modul_28_NETWORK.md"},
    {no:"29",id:"SYMBOL",   ring:"outer",  file:"MODULES/Modul_29_SYMBOL.md"},
    {no:"30",id:"TRUTH",    ring:"outer",  file:"MODULES/Modul_30_TRUTH.md"},
    {no:"31",id:"MEMORY",   ring:"outer",  file:"MODULES/Modul_31_MEMORY.md"},
    {no:"32",id:"LICENCE",  ring:"outer",  file:"MODULES/Modul_32_LICENCE.md"},
    {no:"33",id:"PRIVACY",  ring:"outer",  file:"MODULES/Modul_33_PRIVACY.md"},
    {no:"34",id:"SECURITY", ring:"outer",  file:"MODULES/Modul_34_SECURITY.md"},
    {no:"35",id:"DATA",     ring:"outer",  file:"MODULES/Modul_35_DATA.md"},
    {no:"36",id:"CONFLICT", ring:"outer",  file:"MODULES/Modul_36_CONFLICT.md"},
    {no:"37",id:"DEMOCRACY",ring:"outer",  file:"MODULES/Modul_37_DEMOCRACY.md"},
    {no:"38",id:"GOVERNANCE",ring:"outer", file:"MODULES/Modul_38_GOVERNANCE.md"},
    {no:"39",id:"KNOWLEDGE", ring:"outer", file:"MODULES/Modul_39_KNOWLEDGE.md"},
    {no:"40",id:"ART",       ring:"outer", file:"MODULES/Modul_40_ART.md"},
    {no:"41",id:"FUTURE",    ring:"outer", file:"MODULES/Modul_41_FUTURE.md"},
    {no:"42",id:"DEATH",     ring:"outer", file:"MODULES/Modul_42_DEATH.md"}
  ];

  // --- CORE-Verknüpfungen (voll) ---
  var CORE={
    "01:RESETBOX":["02:WATER","03:SHELTER","09:DEBT"],
    "02:WATER":["04:FOOD","06:BODY","13:NATURE"],
    "03:SH​ELTER":["05:SLEEP","13:NATURE","01:RESETBOX"],
    "04:FOOD":["02:WATER","13:NATURE","25:FINANCE"],
    "05:SLEEP":["03:SHELTER","07:PSYCHE","06:BODY"],
    "06:BODY":["02:WATER","05:SLEEP","07:PSYCHE"],
    "07:PSYCHE":["05:SLEEP","06:BODY","30:TRUTH"],
    "08:DEVICE":["20:ENERGY","32:LICENCE","01:RESETBOX"],
    "09:DEBT":["10:WORK","25:FINANCE","01:RESETBOX"],
    "10:WORK":["09:DEBT","11:SCHOOL","25:FINANCE"],
    "11:SCHOOL":["10:WORK","30:TRUTH","07:PSYCHE"],
    "12:BORDER":["01:RESETBOX","13:NATURE","36:CONFLICT"],
    "13:NATURE":["02:WATER","04:FOOD","20:ENERGY"],
    "14:HEALTH":["02:WATER","06:BODY","07:PSYCHE"],
    "15:CARE":["14:HEALTH","07:PSYCHE","01:RESETBOX"],
    "16:FAMILY":["05:SLEEP","11:SCHOOL","14:HEALTH"],
    "17:ANIMAL":["04:FOOD","13:NATURE","14:HEALTH"],
    "18:CULTURE":["11:SCHOOL","30:TRUTH","29:SYMBOL"],
    "19:MEDIA":["30:TRUTH","32:LICENCE","11:SCHOOL"],
    "20:ENERGY":["08:DEVICE","13:NATURE","25:FINANCE"],
    "21:CLIMATE":["13:NATURE","20:ENERGY","14:HEALTH"],
    "22:MIGRATION":["12:BORDER","13:NATURE","36:CONFLICT"],
    "23:JUSTICE":["09:DEBT","10:WORK","32:LICENCE"],
    "24:COMMUNITY":["11:SCHOOL","18:CULTURE","23:JUSTICE"],
    "25:FINANCE":["09:DEBT","10:WORK","20:ENERGY"],
    "26:HOUSING":["03:SHELTER","05:SLEEP","25:FINANCE"],
    "27:TRANSPORT":["02:WATER","20:ENERGY","22:MIGRATION"],
    "28:NETWORK":["08:DEVICE","20:ENERGY","19:MEDIA"],
    "29:SYMBOL":["18:CULTURE","24:COMMUNITY","30:TRUTH"],
    "30:TRUTH":["11:SCHOOL","19:MEDIA","32:LICENCE"],
    "31:MEMORY":["11:SCHOOL","29:SYMBOL","30:TRUTH"],
    "32:LICENCE":["19:MEDIA","30:TRUTH","08:DEVICE"],
    "33:PRIVACY":["08:DEVICE","19:MEDIA","32:LICENCE"],
    "34:SECURITY":["01:RESETBOX","12:BORDER","36:CONFLICT"],
    "35:DATA":["08:DEVICE","28:NETWORK","32:LICENCE"],
    "36:CONFLICT":["12:BORDER","22:MIGRATION","34:SECURITY"],
    "37:DEMOCRACY":["23:JUSTICE","24:COMMUNITY","25:FINANCE"],
    "38:GOVERNANCE":["23:JUSTICE","37:DEMOCRACY","25:FINANCE"],
    "39:KNOWLEDGE":["11:SCHOOL","30:TRUTH","31:MEMORY"],
    "40:ART":["18:CULTURE","29:SYMBOL","39:KNOWLEDGE"],
    "41:FUTURE":["21:CLIMATE","39:KNOWLEDGE","40:ART"],
    "42:DEATH":["14:HEALTH","15:CARE","41:FUTURE"]
  };

  var SVG_NS="http://www.w3.org/2000/svg", XLINK_NS="http://www.w3.org/1999/xlink";
  var svg=document.getElementById('map'),
      nodes=document.getElementById('nodes-layer'),
      labels=document.getElementById('labels-layer'),
      links=document.getElementById('links-layer');
  var tip=document.getElementById('tip'), diag=document.getElementById('diag');

  function urlFor(file){
    var u=new URL(location.href);
    if(u.pathname.endsWith('map_debug.html')) u.pathname=u.pathname.replace(/map_debug\.html$/,'');
    if(!u.pathname.endsWith('/')) u.pathname+='/';
    return u.origin+u.pathname+'module.html?file='+encodeURIComponent(file);
  }
  function polar(r,a){ return [Math.cos(a)*r, Math.sin(a)*r]; }
  function distributeAngles(n){ var step=(Math.PI*2)/n, start=-Math.PI/2, out=[]; for(var i=0;i<n;i++) out.push(start+i*step); return out; }
  function nodeCenterPos(el){
    var tr=el.getAttribute('transform'); var m=tr && tr.match(/translate\(([-\d.]+),([-\d.]+)\)/);
    return m? {x:parseFloat(m[1]), y:parseFloat(m[2])} : {x:0,y:0};
  }
  function curve(pA,pB){
    var mid={x:(pA.x+pB.x)/2,y:(pA.y+pB.y)/2}, v={x:mid.x*0.08,y:mid.y*0.08},
        c={x:mid.x+v.x,y:mid.y+v.y};
    return "M "+pA.x+" "+pA.y+" Q "+c.x+" "+c.y+" "+pB.x+" "+pB.y;
  }

  function addNodeEvents(a, m){
    var show=function(e){
      tip.textContent=m.no+" "+m.id;
      tip.style.left=e.clientX+'px'; tip.style.top=e.clientY+'px';
      tip.classList.add('show'); highlight(m.id);
    };
    var hide=function(){ tip.classList.remove('show'); clearHighlight(); };
    a.addEventListener('mouseenter', show);
    a.addEventListener('mousemove', function(e){ tip.style.left=e.clientX+'px'; tip.style.top=e.clientY+'px'; });
    a.addEventListener('mouseleave', hide);
    a.addEventListener('focus', function(){ tip.classList.add('show'); highlight(m.id); });
    a.addEventListener('blur', hide);
  }

  function addLabel(m, ring, angle, r, center){
    var offset=(ring==='inner')?86:(ring==='mid')?96:104;
    var p=polar(r+offset, angle), lx=p[0], ly=p[1];
    var g=document.createElementNS(SVG_NS,'g'); g.setAttribute('transform','translate('+lx+','+ly+')'); g.setAttribute('class','label'); g.dataset.id=m.id;
    var line=document.createElementNS(SVG_NS,'line');
    line.setAttribute('x1',0); line.setAttribute('y1',0); line.setAttribute('x2', center.x-lx); line.setAttribute('y2', center.y-ly);
    var rect=document.createElementNS(SVG_NS,'rect');
    var text=document.createElementNS(SVG_NS,'text'); text.textContent=m.no+" "+m.id; text.setAttribute('dominant-baseline','middle');
    var deg=angle*180/Math.PI;
    if(ring==='center'){ text.setAttribute('text-anchor','middle'); text.setAttribute('x',0); }
    else if(deg>-90 && deg<=90){ text.setAttribute('text-anchor','start'); text.setAttribute('x',14); }
    else{ text.setAttribute('text-anchor','end'); text.setAttribute('x',-14); }
    text.setAttribute('y',0);
    g.appendChild(line); g.appendChild(rect); g.appendChild(text); labels.appendChild(g);
    requestAnimationFrame(function(){
      var bb=text.getBBox();
      rect.setAttribute('x', bb.x-10); rect.setAttribute('y', bb.y-8);
      rect.setAttribute('width', bb.width+20); rect.setAttribute('height', bb.height+16);
    });
  }

  function addNode(m, ring, angle, r){
    var p=polar(r,angle), x=p[0], y=p[1];
    var a=document.createElementNS(SVG_NS,'a'); a.classList.add('node', ring);
    var href=urlFor(m.file);
    a.setAttribute('href', href); a.setAttributeNS(XLINK_NS,'xlink:href', href);
    a.setAttribute('transform','translate('+x+','+y+')'); a.dataset.id=m.id;

    var glow=document.createElementNS(SVG_NS,'circle'); glow.setAttribute('class','glow'); glow.setAttribute('r', RS[ring]); a.appendChild(glow);
    var c=document.createElementNS(SVG_NS,'circle'); c.setAttribute('r', RS[ring]); a.appendChild(c);

    addNodeEvents(a, m);
    nodes.appendChild(a);
    addLabel(m, ring, angle, r, {x:x, y:y});
  }

  // Link-Index
  var LINKS=new Map();
  Object.keys(CORE).forEach(function(k){
    var a=k.split(':')[1]; if(!LINKS.has(a)) LINKS.set(a,new Set());
    CORE[k].forEach(function(bk){
      var b=bk.split(':')[1]; if(!LINKS.has(b)) LINKS.set(b,new Set());
      LINKS.get(a).add(b); LINKS.get(b).add(a);
    });
  });

  function setLabelActive(id, on){
    var lab=labels.querySelector('.label[data-id="'+id+'"]'); if(!lab) return;
    if(on) lab.classList.add('active'); else lab.classList.remove('active');
  }
  function dimAll(on){
    var i, ns=document.querySelectorAll('a.node'), ls=labels.querySelectorAll('.label');
    for(i=0;i<ns.length;i++) ns[i].style.opacity=on?.25:1;
    for(i=0;i<ls.length;i++) ls[i].style.opacity=on?.25:1;
  }

  function highlight(id){
    var nodesAll=document.querySelectorAll('a.node'), i;
    for(i=0;i<nodesAll.length;i++){ nodesAll[i].classList.remove('active'); }
    setLabelActive(id, true);

    var active=null;
    for(i=0;i<nodesAll.length;i++){ if(nodesAll[i].dataset.id===id){ active=nodesAll[i]; active.classList.add('active'); break; } }

    // Clear paths
    while(links.firstChild) links.removeChild(links.firstChild);

    var targets = LINKS.get(id) ? Array.from(LINKS.get(id)) : [];
    var targetEls=[], t, el;
    for(i=0;i<targets.length;i++){
      t=targets[i];
      el=null;
      for(var j=0;j<nodesAll.length;j++){ if(nodesAll[j].dataset.id===t){ el=nodesAll[j]; break; } }
      if(el){ targetEls.push(el); setLabelActive(t, true); }
    }

    if(active && targetEls.length){
      var pA=nodeCenterPos(active);
      for(i=0;i<targetEls.length;i++){
        var pB=nodeCenterPos(targetEls[i]);
        var path=document.createElementNS(SVG_NS,'path');
        path.setAttribute('d', curve(pA, pB));
        links.appendChild(path);
      }
      links.classList.add('visible');
      dimAll(true);
      active.style.opacity=1; for(i=0;i<targetEls.length;i++) targetEls[i].style.opacity=1;
      // Labels von aktiven/Targets auch hell
      setLabelActive(id,true);
      for(i=0;i<targets.length;i++) setLabelActive(targets[i],true);
    }else{
      links.classList.remove('visible');
      dimAll(false);
    }
  }

  function clearHighlight(){
    while(links.firstChild) links.removeChild(links.firstChild);
    links.classList.remove('visible');
    dimAll(false);
    // remove label active
    var labs=labels.querySelectorAll('.label'); for(var i=0;i<labs.length;i++) labs[i].classList.remove('active');
  }

  function build(){
    // Zentrum
    var center=MODS.find(function(m){return m.ring==='center';});
    addNode(center,'center',0,0);

    // Ringe
    var rings=['inner','mid','outer'], r, list, ang;
    for(var k=0;k<rings.length;k++){
      r=rings[k];
      list=MODS.filter(function(m){return m.ring===r;});
      ang=distributeAngles(list.length);
      list.forEach(function(m,i){ addNode(m, r, ang[i], R[r]); });
    }

    // Diagnose
    diag.textContent='nodes='+document.querySelectorAll("a.node").length+' | labels='+document.querySelectorAll(".label").length;
  }

  build();
})();
</script>
</body>
</html>
