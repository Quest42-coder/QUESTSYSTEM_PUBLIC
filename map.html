<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QUESTSYSTEM ‚Äì Modul-Map (V7.8)</title>
<meta name="description" content="Interaktive Ring-Map des QUESTSYSTEMS mit Suche, Hover-Verbindungen, gebogenen Kurven, adaptiver Typografie und Dark/Light-Mode." />
<style>
  :root{
    /* Dark Theme (default) */
    --bg:#060b12; --fg:#f2f7ff; --muted:#a8b8d3; --border:#1d2739; --glass:rgba(11,16,26,.68);
    --q1:#51e2ff; --q2:#8dffb8; --q3:#b497ff;
    --ring-inner:#ff6f86; --ring-mid:#e1c94d; --ring-outer:#7cb0ff; --ring-center:#22c7ff;
    --node-bg:#0d1422; --node-stroke:#3b527c; --node-text:#eaf2ff;
    --shadow: 0 16px 42px rgba(0,0,0,.55);
    --header-h:60px;

    /* Typo adaptiv */
    --label-size: clamp(14px, 1.8vw, 21px);
    --center-size: clamp(18px, 2.3vw, 28px);
    --tooltip-size: clamp(12px, 1.4vw, 14px);

    /* Node-Radien */
    --r-node: 56px;
    --r-center: 96px;
  }
  /* Light Theme Tokens */
  .light{
    --bg:#f6f8fc; --fg:#0d1a29; --muted:#53657f; --border:#dbe4f0; --glass:rgba(255,255,255,.86);
    --node-bg:#ffffff; --node-stroke:#b9c7da; --node-text:#0d1a29;
    --ring-inner:#ff4768; --ring-mid:#d6ad00; --ring-outer:#4b83ff; --ring-center:#0db5ff;
    --shadow: 0 10px 28px rgba(0,0,0,.12);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font:16px/1.65 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background:
      radial-gradient(1600px 1000px at 50% 40%, #13223a20 0%, #0f1b2f33 55%, var(--bg) 100%),
      radial-gradient(900px 700px at 12% 14%, rgba(255,255,255,.055), transparent 60%),
      radial-gradient(900px 900px at 88% 84%, rgba(255,255,255,.04), transparent 65%);
    overflow:hidden;
    transition: background-color .25s ease, color .25s ease;
  }

  /* Header */
  header{
    position:fixed; inset:0 0 auto 0; height:var(--header-h); z-index:80;
    display:flex; align-items:center; gap:12px; padding:10px 12px;
    background:var(--glass); border-bottom:1px solid var(--border); backdrop-filter: blur(8px);
  }
  .brand{ color:var(--fg); text-decoration:none; font-weight:900; letter-spacing:.3px; font-size:16px }
  nav{ margin-left:auto; display:flex; gap:10px; align-items:center }
  .dd{ position:relative }
  .dd>button, .theme button{
    color:var(--fg); background:transparent; border:1px solid var(--border);
    padding:6px 12px; border-radius:10px; cursor:pointer; font-weight:800
  }
  .menu{
    position:absolute; right:0; top:calc(100% + 8px); min-width:260px; max-height:60vh; overflow:auto;
    display:none; flex-direction:column; gap:4px; padding:10px;
    background:rgba(10,13,20,.98); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
  }
  .light .menu{ background:#ffffff; }
  .dd:hover .menu, .dd:focus-within .menu{ display:flex }
  .menu a{ color:var(--fg); text-decoration:none; padding:10px 12px; border-radius:8px; font-size:15px }
  .menu a:hover, .menu a:focus{ background:rgba(255,255,255,.08); outline: none }
  .light .menu a:hover, .light .menu a:focus{ background:#eef3fb }
  .theme{ display:flex; align-items:center; gap:8px; }

  /* Suche */
  .search{
    display:flex; align-items:center; gap:8px; padding:0 8px;
    border:1px solid var(--border); border-radius:10px; background:transparent; height:36px;
  }
  .search input{
    background:transparent; color:var(--fg); border:none; outline:none; width:220px; font-weight:700;
  }
  .search input::placeholder{ color:var(--muted) }
  .search .clear{ cursor:pointer; border:none; background:transparent; color:var(--muted); font-size:18px }

  /* B√ºhne */
  .stage{ position:absolute; inset:var(--header-h) 0 0 0; display:grid; place-items:center; }
  svg{ width:min(1400px, 96.5vw); height:min(1400px, calc(96.5vh - var(--header-h))); }

  /* Ringe */
  .ring{ fill:none; stroke-opacity:.95; }
  .ring.inner{ stroke:var(--ring-inner); stroke-width:2.6 }
  .ring.mid{   stroke:var(--ring-mid);   stroke-width:2.6 }
  .ring.outer{ stroke:var(--ring-outer); stroke-width:2.6 }

  /* Verbindungen (gekr√ºmmt) */
  .links path{
    stroke: url(#qgrad); stroke-opacity:0; stroke-width:3.6; fill:none;
    filter: drop-shadow(0 0 0 rgba(81,226,255,0));
    transition: stroke-opacity .12s ease, filter .2s ease;
  }
  .links.visible path{
    stroke-opacity:1;
    filter: drop-shadow(0 0 18px rgba(81,226,255,.45));
    animation: lineGlow 1.8s ease-in-out infinite;
  }
  .links.hidden{ opacity:0; pointer-events:none }

  /* Nodes Layer */
  g.nodes{ filter: drop-shadow(0 4px 14px rgba(0,0,0,.55)); }

  /* Pulse + Glow */
  @keyframes pulse { 0%,100%{ transform: translateY(0) scale(1); } 50%{ transform: translateY(-1px) scale(1.04); } }
  @keyframes ringHalo { 0%{ stroke-width:9; opacity:.7 } 50%{ stroke-width:13; opacity:.18 } 100%{ stroke-width:9; opacity:.7 } }
  @keyframes lineGlow{ 0%,100%{ filter: drop-shadow(0 0 12px rgba(81,226,255,.35)); } 50%{ filter: drop-shadow(0 0 24px rgba(141,255,184,.5)); } }

  /* Knoten */
  a.node{ cursor:pointer; transition: transform .12s ease, opacity .12s ease; outline:none }
  a.node:hover{ transform: translateY(-1px) scale(1.02); }
  a.node:focus-visible{ outline:2px dashed #7de0ff; outline-offset:4px }
  .node circle{ fill:var(--node-bg); stroke:var(--node-stroke); stroke-width:2.2; transition: stroke-width .12s ease; }
  .node circle.glow{ fill:none; stroke:rgba(255,255,255,.2); stroke-width:9; opacity:.75; filter:blur(2px); }
  .node.active{ animation: pulse 1.8s ease-in-out infinite; }
  .node.active circle{ stroke:url(#qgrad); stroke-width:3.2; }
  .node.active .glow{ animation: ringHalo 2.2s ease-in-out infinite; }
  .node.linked circle{ stroke:url(#qgrad); stroke-width:3.0; opacity:.98; }
  .node.dim { opacity:.25; }

  /* Zentrum */
  .center circle.core{ fill:transparent; stroke:#87a6c8; stroke-dasharray:4 6; stroke-width:2.6; }
  .center a.node text{ fill:#e6f8ff; font-size:var(--center-size); font-weight:1000; letter-spacing:.6px }
  .center a.node circle{ fill:rgba(22,30,48,.9); stroke:url(#qgrad); stroke-width:3.2 }
  .light .center a.node circle{ fill:#ffffff }

  /* Labels */
  .label text{
    font-weight:1000; letter-spacing:.4px; font-size:var(--label-size);
    paint-order: stroke; stroke: rgba(5,9,16,.82); stroke-width:5px;
  }
  .label .t-center{ fill:var(--ring-center) }
  .label .t-inner{  fill:var(--ring-inner) }
  .label .t-mid{    fill:var(--ring-mid) }
  .label .t-outer{  fill:var(--ring-outer) }
  .label line{ stroke:#c9e1ff; stroke-opacity:.92; stroke-width:2.2; }
  .label.active text{ fill:#06131c; stroke:none }
  .label.active rect{ fill:url(#qgrad) }
  .label rect{ fill:rgba(12,18,32,.9); stroke:1px solid #28466f; rx:9; ry:9; }
  .light .label rect{ fill:#ffffff; stroke:#dbe4f0 }
  .label.dim { opacity:.25; }

  /* Legende */
  .legend{
    position:fixed; inset:auto 12px 12px 12px; z-index:70;
    display:flex; gap:10px; align-items:center; justify-content:center;
    background:rgba(12,16,24,.62); border:1px solid var(--border); border-radius:10px; padding:8px 12px; backdrop-filter: blur(6px);
  }
  .light .legend{ background:#ffffffd0 }
  .chip{display:inline-flex; align-items:center; gap:8px; font-size:13px}
  .sw{width:14px; height:14px; border-radius:50%}
  .sw.center{background:var(--ring-center)}
  .sw.inner{background:var(--ring-inner)}
  .sw.mid{background:var(--ring-mid)}
  .sw.outer{background:var(--ring-outer)}

  /* Tooltip */
  .tip{
    position:fixed; z-index:90; pointer-events:none;
    transform:translate(-50%, calc(-100% - 12px));
    background:#0f1624; border:1px solid #2b3548; color:var(--fg);
    padding:10px 12px; border-radius:10px; font-size:var(--tooltip-size); white-space:nowrap;
    opacity:0; transition:opacity .12s ease, transform .12s ease; box-shadow:var(--shadow);
  }
  .light .tip{ background:#ffffff; border-color:#dbe4f0 }
  .tip.show{ opacity:1; transform:translate(-50%, calc(-100% - 10px)) }
  .tip small{ color:var(--muted) }
</style>
</head>
<body>
<header aria-label="Seitennavigation">
  <a class="brand" href="./index.html">üçÑ QUESTSYSTEM</a>
  <nav>
    <div class="dd">
      <button aria-haspopup="menu">System</button>
      <div class="menu" role="menu">
        <a role="menuitem" href="./index.html">Start</a>
        <a role="menuitem" href="./map.html">Modul-Map</a>
        <a role="menuitem" href="module.html?file=ARTIST_PROFILE.md">Artist Profile</a>
        <a role="menuitem" href="module.html?file=MODULES/Modul_32_LICENCE.md">Licence</a>
        <a role="menuitem" href="https://github.com/Quest42-coder/QUESTSYSTEM_PUBLIC" target="_blank" rel="noopener">Repository</a>
      </div>
    </div>
    <div class="dd">
      <button aria-haspopup="menu">Ethik</button>
      <div class="menu" role="menu">
        <a role="menuitem" href="module.html?file=Dignity_Clause.md">Dignity Clause</a>
        <a role="menuitem" href="module.html?file=14_GEBOTE_V2.1.md">14 Gebote (V2.1)</a>
        <a role="menuitem" href="module.html?file=14_GEBOTE_DISCUSSION.md">Diskussion</a>
      </div>
    </div>
    <div class="dd">
      <button aria-haspopup="menu">Module</button>
      <div class="menu" role="menu" id="menu-mods"></div>
    </div>

    <div class="search" role="search">
      <span>üîé</span>
      <input id="q" type="text" placeholder="Suche Modul/Nummer‚Ä¶" aria-label="Modulsuche" />
      <button class="clear" id="q-clear" title="Suche l√∂schen">√ó</button>
    </div>

    <div class="theme">
      <button id="toggleTheme" title="Dark / Light umschalten">üåô</button>
    </div>
  </nav>
</header>

<div class="stage">
  <svg id="map" viewBox="-700 -700 1400 1400"
       xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
       role="img" aria-label="Konzentrische Modul-Ringe des QUESTSYSTEMS">
    <defs>
      <linearGradient id="qgrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%"  stop-color="var(--q1)"/>
        <stop offset="50%" stop-color="var(--q2)"/>
        <stop offset="100%" stop-color="var(--q3)"/>
      </linearGradient>
    </defs>

    <!-- Ringe -->
    <g class="rings">
      <circle class="ring inner" r="220"></circle>
      <circle class="ring mid"   r="380"></circle>
      <circle class="ring outer" r="540"></circle>
    </g>

    <!-- Verbindungen -->
    <g class="links hidden" id="links-layer"></g>

    <!-- Zentrum -->
    <g class="center">
      <circle class="core" r="100"></circle>
      <!-- RESETBOX Node via JS -->
    </g>

    <!-- Nodes -->
    <g class="nodes" id="nodes-layer"></g>

    <!-- Labels -->
    <g class="labels" id="labels-layer"></g>
  </svg>
</div>

<div class="legend" aria-hidden="true">
  <span class="chip"><span class="sw center"></span>RESETBOX</span>
  <span class="chip"><span class="sw inner"></span>Existential</span>
  <span class="chip"><span class="sw mid"></span>Societal</span>
  <span class="chip"><span class="sw outer"></span>Structural</span>
</div>

<div id="tip" class="tip" role="status" aria-live="polite"></div>

<script>
/* ===== Daten ===== */
const MODS = [
  {no:"01", id:"RESETBOX", ring:"center", file:"MODULES/Modul_01_RESETBOX.md"},
  {no:"02", id:"WATER",   ring:"inner", file:"MODULES/Modul_02_WATER.md"},
  {no:"03", id:"SHELTER", ring:"inner", file:"MODULES/Modul_03_SHELTER.md"},
  {no:"04", id:"FOOD",    ring:"inner", file:"MODULES/Modul_04_FOOD.md"},
  {no:"05", id:"SLEEP",   ring:"inner", file:"MODULES/Modul_05_SLEEP.md"},
  {no:"06", id:"BODY",    ring:"inner", file:"MODULES/Modul_06_BODY.md"},
  {no:"07", id:"PSYCHE",  ring:"inner", file:"MODULES/Modul_07_PSYCHE.md"},
  {no:"08", id:"DEVICE",  ring:"inner", file:"MODULES/Modul_08_DEVICE.md"},
  {no:"09", id:"DEBT",    ring:"inner", file:"MODULES/Modul_09_DEBT.md"},
  {no:"10", id:"WORK",      ring:"mid", file:"MODULES/Modul_10_WORK.md"},
  {no:"11", id:"SCHOOL",    ring:"mid", file:"MODULES/Modul_11_SCHOOL.md"},
  {no:"12", id:"BORDER",    ring:"mid", file:"MODULES/Modul_12_BORDER.md"},
  {no:"13", id:"NATURE",    ring:"mid", file:"MODULES/Modul_13_NATURE.md"},
  {no:"14", id:"HEALTH",    ring:"mid", file:"MODULES/Modul_14_HEALTH.md"},
  {no:"15", id:"CARE",      ring:"mid", file:"MODULES/Modul_15_CARE.md"},
  {no:"16", id:"FAMILY",    ring:"mid", file:"MODULES/Modul_16_FAMILY.md"},
  {no:"17", id:"ANIMAL",    ring:"mid", file:"MODULES/Modul_17_ANIMAL.md"},
  {no:"18", id:"CULTURE",   ring:"mid", file:"MODULES/Modul_18_CULTURE.md"},
  {no:"19", id:"MEDIA",     ring:"mid", file:"MODULES/Modul_19_MEDIA.md"},
  {no:"20", id:"ENERGY",    ring:"mid", file:"MODULES/Modul_20_ENERGY.md"},
  {no:"21", id:"CLIMATE",   ring:"mid", file:"MODULES/Modul_21_CLIMATE.md"},
  {no:"22", id:"MIGRATION", ring:"mid", file:"MODULES/Modul_22_MIGRATION.md"},
  {no:"23", id:"JUSTICE",   ring:"mid", file:"MODULES/Modul_23_JUSTICE.md"},
  {no:"24", id:"COMMUNITY", ring:"mid", file:"MODULES/Modul_24_COMMUNITY.md"},
  {no:"25", id:"FINANCE",    ring:"outer", file:"MODULES/Modul_25_FINANCE.md"},
  {no:"26", id:"HOUSING",    ring:"outer", file:"MODULES/Modul_26_HOUSING.md"},
  {no:"27", id:"TRANSPORT",  ring:"outer", file:"MODULES/Modul_27_TRANSPORT.md"},
  {no:"28", id:"NETWORK",    ring:"outer", file:"MODULES/Modul_28_NETWORK.md"},
  {no:"29", id:"SYMBOL",     ring:"outer", file:"MODULES/Modul_29_SYMBOL.md"},
  {no:"30", id:"TRUTH",      ring:"outer", file:"MODULES/Modul_30_TRUTH.md"},
  {no:"31", id:"MEMORY",     ring:"outer", file:"MODULES/Modul_31_MEMORY.md"},
  {no:"32", id:"LICENCE",    ring:"outer", file:"MODULES/Modul_32_LICENCE.md"},
  {no:"33", id:"PRIVACY",    ring:"outer", file:"MODULES/Modul_33_PRIVACY.md"},
  {no:"34", id:"SECURITY",   ring:"outer", file:"MODULES/Modul_34_SECURITY.md"},
  {no:"35", id:"DATA",       ring:"outer", file:"MODULES/Modul_35_DATA.md"},
  {no:"36", id:"CONFLICT",   ring:"outer", file:"MODULES/Modul_36_CONFLICT.md"},
  {no:"37", id:"DEMOCRACY",  ring:"outer", file:"MODULES/Modul_37_DEMOCRACY.md"},
  {no:"38", id:"GOVERNANCE", ring:"outer", file:"MODULES/Modul_38_GOVERNANCE.md"},
  {no:"39", id:"KNOWLEDGE",  ring:"outer", file:"MODULES/Modul_39_KNOWLEDGE.md"},
  {no:"40", id:"ART",        ring:"outer", file:"MODULES/Modul_40_ART.md"},
  {no:"41", id:"FUTURE",     ring:"outer", file:"MODULES/Modul_41_FUTURE.md"},
  {no:"42", id:"DEATH",      ring:"outer", file:"MODULES/Modul_42_DEATH.md"},
];
/* Kern-Verkn√ºpfungen (symmetrisch gerendert) */
const CORE = {
  "01:RESETBOX": ["02:WATER","03:SHELTER","09:DEBT"],
  "02:WATER":    ["04:FOOD","06:BODY","13:NATURE"],
  "03:SHELTER":  ["05:SLEEP","13:NATURE","01:RESETBOX"],
  "04:FOOD":     ["02:WATER","13:NATURE","25:FINANCE"],
  "05:SLEEP":    ["03:SHELTER","07:PSYCHE","06:BODY"],
  "06:BODY":     ["02:WATER","05:SLEEP","07:PSYCHE"],
  "07:PSYCHE":   ["05:SLEEP","06:BODY","30:TRUTH"],
  "08:DEVICE":   ["20:ENERGY","32:LICENCE","01:RESETBOX"],
  "09:DEBT":     ["10:WORK","25:FINANCE","01:RESETBOX"],

  "10:WORK":      ["09:DEBT","11:SCHOOL","25:FINANCE"],
  "11:SCHOOL":    ["10:WORK","30:TRUTH","07:PSYCHE"],
  "12:BORDER":    ["01:RESETBOX","13:NATURE","36:CONFLICT"],
  "13:NATURE":    ["02:WATER","04:FOOD","20:ENERGY"],
  "14:HEALTH":    ["02:WATER","06:BODY","07:PSYCHE"],
  "15:CARE":      ["14:HEALTH","07:PSYCHE","01:RESETBOX"],
  "16:FAMILY":    ["05:SLEEP","11:SCHOOL","14:HEALTH"],
  "17:ANIMAL":    ["04:FOOD","13:NATURE","14:HEALTH"],
  "18:CULTURE":   ["11:SCHOOL","30:TRUTH","29:SYMBOL"],
  "19:MEDIA":     ["30:TRUTH","32:LICENCE","11:SCHOOL"],
  "20:ENERGY":    ["08:DEVICE","13:NATURE","25:FINANCE"],
  "21:CLIMATE":   ["13:NATURE","20:ENERGY","14:HEALTH"],
  "22:MIGRATION": ["12:BORDER","13:NATURE","36:CONFLICT"],
  "23:JUSTICE":   ["09:DEBT","10:WORK","32:LICENCE"],
  "24:COMMUNITY": ["11:SCHOOL","18:CULTURE","23:JUSTICE"],

  "25:FINANCE":   ["09:DEBT","10:WORK","20:ENERGY"],
  "26:HOUSING":   ["03:SHELTER","05:SLEEP","25:FINANCE"],
  "27:TRANSPORT": ["02:WATER","20:ENERGY","22:MIGRATION"],
  "28:NETWORK":   ["08:DEVICE","20:ENERGY","19:MEDIA"],
  "29:SYMBOL":    ["18:CULTURE","24:COMMUNITY","30:TRUTH"],
  "30:TRUTH":     ["11:SCHOOL","19:MEDIA","32:LICENCE"],
  "31:MEMORY":    ["11:SCHOOL","29:SYMBOL","30:TRUTH"],
  "32:LICENCE":   ["19:MEDIA","30:TRUTH","08:DEVICE"],
  "33:PRIVACY":   ["08:DEVICE","19:MEDIA","32:LICENCE"],
  "34:SECURITY":  ["01:RESETBOX","12:BORDER","36:CONFLICT"],
  "35:DATA":      ["08:DEVICE","28:NETWORK","32:LICENCE"],
  "36:CONFLICT":  ["12:BORDER","22:MIGRATION","34:SECURITY"],
  "37:DEMOCRACY": ["23:JUSTICE","24:COMMUNITY","25:FINANCE"],
  "38:GOVERNANCE":["23:JUSTICE","37:DEMOCRACY","25:FINANCE"],
  "39:KNOWLEDGE": ["11:SCHOOL","30:TRUTH","31:MEMORY"],
  "40:ART":       ["18:CULTURE","29:SYMBOL","39:KNOWLEDGE"],
  "41:FUTURE":    ["21:CLIMATE","39:KNOWLEDGE","40:ART"],
  "42:DEATH":     ["14:HEALTH","15:CARE","41:FUTURE"],
};

/* ===== Helpers ===== */
const SVG_NS="http://www.w3.org/2000/svg"; const XLINK_NS="http://www.w3.org/1999/xlink";
const R = { inner:220, mid:380, outer:540, center:0 };
const RS = {
  inner:parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--r-node')) || 56,
  mid:parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--r-node')) || 56,
  outer:parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--r-node')) || 56,
  center:parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--r-center')) || 96
};
function polar(r, a){ return [Math.cos(a)*r, Math.sin(a)*r]; }
function urlFor(filePath){
  const u = new URL(window.location.href);
  if (u.pathname.endsWith('map.html')) u.pathname = u.pathname.replace(/map\.html$/,'');
  if (!u.pathname.endsWith('/')) u.pathname += '/';
  return u.origin + u.pathname + 'module.html?file=' + encodeURIComponent(filePath);
}
/* symmetrische Kanten */
const LINKS = new Map();
for (const [k, arr] of Object.entries(CORE)) {
  const a = k.split(':')[1];
  if (!LINKS.has(a)) LINKS.set(a, new Set());
  arr.forEach(bKey=>{
    const b = bKey.split(':')[1];
    if (!LINKS.has(b)) LINKS.set(b, new Set());
    LINKS.get(a).add(b); LINKS.get(b).add(a);
  });
}

/* ===== Build ===== */
const svg = document.getElementById('map');
const nodesLayer  = document.getElementById('nodes-layer');
const labelsLayer = document.getElementById('labels-layer');
const linksLayer  = document.getElementById('links-layer');
const tip = document.getElementById('tip');

function distributeAngles(len){
  const step=(Math.PI*2)/len, start=-Math.PI/2;
  return Array.from({length:len},(_,i)=>start+i*step);
}

function addNode(mod, ring, angle, r){
  const [x,y] = polar(r, angle);
  const a = document.createElementNS(SVG_NS,'a');
  a.classList.add('node', ring);
  a.setAttribute('href', urlFor(mod.file));
  a.setAttributeNS(XLINK_NS,'xlink:href', urlFor(mod.file));
  a.setAttribute('transform',`translate(${x},${y})`);
  a.dataset.id = mod.id;
  a.dataset.ring = ring;
  a.setAttribute('tabindex','0');

  const glow = document.createElementNS(SVG_NS,'circle'); glow.setAttribute('r', RS[ring]); glow.setAttribute('class','glow'); a.appendChild(glow);
  const c = document.createElementNS(SVG_NS,'circle'); c.setAttribute('r', RS[ring]); a.appendChild(c);

  addNodeEvents(a, mod);
  nodesLayer.appendChild(a);

  addLabel(mod, ring, angle, r, {x,y});
}

function addLabel(mod, ring, angle, r, center){
  const offset = ring==='inner'? 86 : ring==='mid'? 96 : 104;
  const [lx,ly] = polar(r+offset, angle);

  const g = document.createElementNS(SVG_NS,'g');
  g.setAttribute('transform', `translate(${lx},${ly})`);
  g.setAttribute('class','label');
  g.dataset.id = mod.id;
  g.dataset.ring = ring;

  const line = document.createElementNS(SVG_NS,'line');
  line.setAttribute('x1', 0); line.setAttribute('y1', 0);
  line.setAttribute('x2', center.x - lx); line.setAttribute('y2', center.y - ly);
  g.appendChild(line);

  const text = document.createElementNS(SVG_NS,'text');
  text.textContent = `${mod.no} ${mod.id}`;
  text.setAttribute('dominant-baseline','middle');
  text.classList.add(ring==='inner'?'t-inner': ring==='mid'?'t-mid': ring==='outer'?'t-outer':'t-center');

  const deg = angle * 180/Math.PI;
  if (ring === 'center'){
    text.setAttribute('text-anchor','middle'); text.setAttribute('x', 0);
  } else if (deg > -90 && deg <= 90){ text.setAttribute('text-anchor','start'); text.setAttribute('x', 14); }
  else { text.setAttribute('text-anchor','end'); text.setAttribute('x', -14); }
  text.setAttribute('y', 0);

  const rect = document.createElementNS(SVG_NS,'rect');
  g.appendChild(rect); g.appendChild(text);
  labelsLayer.appendChild(g);

  requestAnimationFrame(()=>{
    const bb = text.getBBox();
    rect.setAttribute('x', bb.x - 12);
    rect.setAttribute('y', bb.y - 10);
    rect.setAttribute('width', bb.width + 24);
    rect.setAttribute('height', bb.height + 20);
  });
}

function buildMap(){
  // Center (RESETBOX)
  const m0 = MODS.find(m=>m.ring==='center');
  addNode(m0, 'center', 0, 0);
  const centerNode = nodesLayer.querySelector('a.node.center');
  centerNode.setAttribute('transform','translate(0,0)');

  // Label f√ºr Zentrum
  const g = document.createElementNS(SVG_NS,'g');
  g.setAttribute('transform','translate(0,0)');
  g.setAttribute('class','label active');
  g.dataset.id = m0.id; g.dataset.ring='center';
  const rect = document.createElementNS(SVG_NS,'rect'); g.appendChild(rect);
  const text = document.createElementNS(SVG_NS,'text');
  text.textContent = `01 ${m0.id}`; text.setAttribute('text-anchor','middle'); text.setAttribute('y','0');
  text.setAttribute('dominant-baseline','middle'); text.classList.add('t-center'); text.style.fontSize = 'var(--center-size)';
  g.appendChild(text);
  labelsLayer.appendChild(g);
  requestAnimationFrame(()=>{
    const bb = text.getBBox();
    rect.setAttribute('x', bb.x - 14); rect.setAttribute('y', bb.y - 12);
    rect.setAttribute('width', bb.width + 28); rect.setAttribute('height', bb.height + 24);
  });

  // Ringe
  const byRing = {inner:[], mid:[], outer:[]};
  MODS.forEach(m=>{ if(m.ring!=='center') byRing[m.ring].push(m); });
  for(const ring of ['inner','mid','outer']){
    const list = byRing[ring];
    const angles = distributeAngles(list.length);
    list.forEach((m,i)=> addNode(m, ring, angles[i], R[ring]));
  }

  // einfache Label-Kollision-Entzerrung (vertikal)
  resolveLabelCollisions();
}

/* ===== Verbindungen als Kurven ===== */
function nodeCenterPos(nodeEl){
  const tr = nodeEl.getAttribute('transform');
  const m = tr && tr.match(/translate\(([-\d.]+),([-\d.]+)\)/);
  return m ? {x:parseFloat(m[1]), y:parseFloat(m[2])} : {x:0,y:0};
}
function curvePath(pA, pB){
  // Quadratic-Bezier: Kontrollpunkt radial leicht nach au√üen
  const mid = { x:(pA.x+pB.x)/2, y:(pA.y+pB.y)/2 };
  const v  = { x:mid.x*0.08, y:mid.y*0.08 };
  const c  = { x:mid.x+v.x, y:mid.y+v.y };
  return `M ${pA.x} ${pA.y} Q ${c.x} ${c.y} ${pB.x} ${pB.y}`;
}

function setLabelActive(id, on){
  const label = labelsLayer.querySelector(`.label[data-id="${id}"]`);
  if(!label) return;
  if(on) label.classList.add('active'); else label.classList.remove('active');
}

function dimAll(on){
  document.querySelectorAll('a.node').forEach(n => n.classList.toggle('dim', on));
  labelsLayer.querySelectorAll('.label').forEach(l => l.classList.toggle('dim', on));
}

function highlight(id){
  document.querySelectorAll('a.node').forEach(n => n.classList.remove('active','linked'));
  const active = Array.from(document.querySelectorAll('a.node')).find(n => n.dataset.id === id);
  if (active) active.classList.add('active');

  setLabelActive(id, true);

  const targets = Array.from(LINKS.get(id) || []);
  const targetEls = [];
  targets.forEach(tid=>{
    const el = Array.from(document.querySelectorAll('a.node')).find(n => n.dataset.id === tid);
    if(el){ el.classList.add('linked'); targetEls.push(el); }
    setLabelActive(tid, true);
  });

  while (linksLayer.firstChild) linksLayer.removeChild(linksLayer.firstChild);
  if (active && targetEls.length){
    const pA = nodeCenterPos(active);
    targetEls.forEach(el=>{
      const pB = nodeCenterPos(el);
      const path = document.createElementNS(SVG_NS,'path');
      path.setAttribute('d', curvePath(pA, pB));
      linksLayer.appendChild(path);
    });
    linksLayer.classList.remove('hidden'); linksLayer.classList.add('visible');
    dimAll(true);
    // Undim aktive & verlinkte
    active.classList.remove('dim');
    targetEls.forEach(e=>e.classList.remove('dim'));
    [id, ...targets].forEach(t=>{
      const lab = labelsLayer.querySelector(`.label[data-id="${t}"]`);
      if(lab) lab.classList.remove('dim');
    });
  }else{
    linksLayer.classList.remove('visible'); linksLayer.classList.add('hidden');
    dimAll(false);
  }
}

function clearHighlight(){
  document.querySelectorAll('a.node').forEach(n => n.classList.remove('active','linked','dim'));
  labelsLayer.querySelectorAll('.label').forEach(l => l.classList.remove('active','dim'));
  while (linksLayer.firstChild) linksLayer.removeChild(linksLayer.firstChild);
  linksLayer.classList.remove('visible'); linksLayer.classList.add('hidden');
}

/* ===== Events ===== */
function addNodeEvents(anchor, mod){
  const show = (e)=>{
    tip.innerHTML = `${mod.no} ${mod.id}<br><small>√ñffnen</small>`;
    tip.style.left = e.clientX+'px'; tip.style.top = e.clientY+'px';
    tip.classList.add('show');
    highlight(mod.id);
  };
  const hide = ()=>{
    tip.classList.remove('show');
    clearHighlight();
  };
  anchor.addEventListener('mouseenter', show);
  anchor.addEventListener('mousemove', (e)=>{ tip.style.left = e.clientX+'px'; tip.style.top = e.clientY+'px'; });
  anchor.addEventListener('mouseleave', hide);
  anchor.addEventListener('focus', (e)=>{ tip.classList.add('show'); highlight(mod.id); });
  anchor.addEventListener('blur', hide);
}

/* ===== Header: Modul-Men√º ===== */
(function fillMenu(){
  const menu = document.getElementById('menu-mods');
  MODS.forEach(m=>{
    const a = document.createElement('a');
    a.href = 'module.html?file=' + encodeURIComponent(m.file);
    a.textContent = `${m.no} ${m.id}`;
    a.setAttribute('role','menuitem');
    menu.appendChild(a);
  });
})();

/* ===== Suche ===== */
(function searchInit(){
  const input = document.getElementById('q');
  const clear = document.getElementById('q-clear');
  const norm = s => s.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();

  function runSearch(){
    const q = norm(input.value.trim());
    if(!q){
      clearHighlight();
      return;
    }
    // Finde best match: Nummer oder Name enth√§lt q
    const match = MODS.find(m => norm(m.no).startsWith(q) || norm(m.id).includes(q));
    if(!match){ clearHighlight(); return; }
    highlight(match.id);
    // Tooltip soft positionieren auf Mitte
    tip.classList.add('show');
    tip.innerHTML = `${match.no} ${match.id}<br><small>Enter zum √ñffnen</small>`;
  }

  input.addEventListener('input', runSearch);
  input.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const q = input.value.trim();
      const match = MODS.find(m => m.no.startsWith(q) || m.id.toLowerCase().includes(q.toLowerCase()));
      if(match){
        window.location.href = urlFor(match.file);
      }
    }else if(e.key === 'Escape'){
      input.value = ''; clearHighlight();
    }
  });
  clear.addEventListener('click', ()=>{
    input.value=''; input.focus(); clearHighlight();
  });
})();

/* ===== Theme Toggle (persistiert) ===== */
(function themeInit(){
  const saved = localStorage.getItem('qs_theme');
  if(saved === 'light'){ document.body.classList.add('light'); }
  const btn = document.getElementById('toggleTheme');
  const setIcon = ()=> btn.textContent = document.body.classList.contains('light') ? '‚òÄÔ∏è' : 'üåô';
  setIcon();
  btn.addEventListener('click', ()=>{
    document.body.classList.toggle('light');
    localStorage.setItem('qs_theme', document.body.classList.contains('light') ? 'light' : 'dark');
    setIcon();
  });
})();

/* ===== Label-Kollisionen grob l√∂sen ===== */
function resolveLabelCollisions(){
  const labels = Array.from(labelsLayer.querySelectorAll('.label'));
  const getBox = el => el.getBBox();
  let moved = true, safety=0;
  while(moved && safety<10){
    moved = false; safety++;
    for(let i=0;i<labels.length;i++){
      for(let j=i+1;j<labels.length;j++){
        const a = labels[i], b = labels[j];
        const A = getBox(a), B = getBox(b);
        const overlap = !(A.x+A.width < B.x || B.x+B.width < A.x || A.y+A.height < B.y || B.y+B.height < A.y);
        if(overlap){
          // verschiebe das untere Label leicht nach au√üen
          const da = /translate\(([-\d.]+),([-\d.]+)\)/.exec(a.getAttribute('transform'));
          const db = /translate\(([-\d.]+),([-\d.]+)\)/.exec(b.getAttribute('transform'));
          if(da && db){
            const ay = parseFloat(da[2]), by = parseFloat(db[2]);
            if(ay <= by){
              a.setAttribute('transform', `translate(${da[1]}, ${ay-6})`);
              b.setAttribute('transform', `translate(${db[1]}, ${by+6})`);
            }else{
              a.setAttribute('transform', `translate(${da[1]}, ${ay+6})`);
              b.setAttribute('transform', `translate(${db[1]}, ${by-6})`);
            }
            moved = true;
          }
        }
      }
    }
  }
}

/* ===== Init ===== */
buildMap();
</script>
</body>
</html>
