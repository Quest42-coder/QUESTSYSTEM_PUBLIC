<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QUESTSYSTEM – Preview (RESETBOX + Existential)</title>
<style>
  :root{
    --bg:#0b0f17; --fg:#eaf2ff; --muted:#9fb0c6;
    --inner:#ffb0bd; --edge:#8fb3ff; --edge-strong:#6fd0ff;
    --node-border:#2a3344; --node-hover:#78a5ff; --cut:#0b0f17;
    --shadow:0 16px 40px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg); overflow:hidden;
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:
      radial-gradient(1400px 900px at 50% 40%, #11182a 0%, #0e1422 55%, var(--bg) 100%),
      radial-gradient(1000px 800px at 15% 10%, rgba(255,255,255,.05), transparent 60%),
      radial-gradient(800px 900px at 85% 85%, rgba(255,255,255,.035), transparent 65%);
  }
  .stage{ position:absolute; inset:0; display:grid; place-items:center; padding:8px; }
  svg{ width:min(1200px,96vw); height:min(1200px,96vh); }

  /* Ring */
  .ring{ fill:none; stroke-width:2.2; opacity:.92; filter: drop-shadow(0 4px 18px rgba(0,0,0,.38)); }
  .ring-inner{ stroke:var(--inner) }

  /* Edges */
  .edges path{
    stroke:var(--edge); stroke-width:2.2; fill:none; opacity:0;
    vector-effect:non-scaling-stroke; transition:opacity .12s ease, stroke-width .12s ease, stroke .12s ease;
  }
  .edges path.on{ opacity:.98; stroke:var(--edge-strong); stroke-width:3.2; filter: drop-shadow(0 2px 8px rgba(90,180,255,.35)); }

  /* Nodes */
  .node{ filter: drop-shadow(0 8px 24px rgba(0,0,0,.5)); transition: transform .14s ease; }
  .node .cut{ fill:var(--cut); }
  .node .rim{ fill:transparent; stroke:var(--node-border); stroke-width:2.1; }
  .node .hit{ fill:rgba(255,255,255,0); cursor:pointer; pointer-events:all; }
  .node:hover{ transform: translateY(-2px) scale(1.035); }
  .node:hover .rim{ stroke:var(--node-hover); }
  .node.active .rim{ stroke:var(--edge-strong); stroke-width:3; filter: drop-shadow(0 0 20px rgba(120,220,255,.45)); }

  .node text{
    font-weight:1000; letter-spacing:.4px;
    text-anchor:middle; dominant-baseline:middle; pointer-events:none;
    paint-order: stroke; stroke:rgba(12,16,24,.78); stroke-width:3;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,.35));
    font-size:32px; fill:#531b25;
  }

  /* Center RESETBOX */
  .center .cut{ fill:var(--cut); }
  .center .rim{ fill:transparent; stroke:#a7c4ee; stroke-dasharray:8 12; stroke-width:3.2; }
  .center text{
    fill:#fff; font-weight:1000; font-size:88px; letter-spacing:1.1px;
    text-anchor:middle; dominant-baseline:middle;
    paint-order: stroke; stroke:rgba(12,16,24,.8); stroke-width:3.2;
    filter: drop-shadow(0 3px 0 rgba(0,0,0,.38));
  }
  .center .hit{ fill:rgba(255,255,255,0); cursor:pointer; }

  /* Tooltip */
  .tip{
    position:fixed; z-index:70; pointer-events:none;
    background:#0f1624; border:1px solid #1e2635; color:var(--fg);
    padding:8px 10px; border-radius:10px; font-size:12px; white-space:nowrap;
    opacity:0; transform:translate(-50%,-140%); transition:opacity .12s ease, transform .12s ease;
    box-shadow: var(--shadow);
  }
  .tip.show{ opacity:1; transform:translate(-50%,-150%); }
</style>
</head>
<body>
<div class="stage">
  <svg id="ringmap" viewBox="-600 -600 1200 1200" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g class="edges" id="edges"></g>

    <!-- Existential Ring -->
    <circle class="ring ring-inner" r="220"></circle>

    <!-- RESETBOX -->
    <a class="node-anchor" xlink:href="module.html?file=MODULES/Modul_01_RESETBOX.md" href="module.html?file=MODULES/Modul_01_RESETBOX.md">
      <g class="center" transform="translate(0,0)" tabindex="0" data-id="01" aria-label="01 RESETBOX">
        <circle class="cut" r="185"></circle>
        <circle class="rim" r="185"></circle>
        <text y="8">RESETBOX</text>
        <circle class="hit" r="185"></circle>
      </g>
    </a>
  </svg>
</div>
<div id="tip" class="tip" role="status" aria-live="polite"></div>

<script>
/* --- Daten nur für Existential 01–09 --- */
const MODS = [
  {no:"01", label:"RESETBOX", ring:"center", file:"MODULES/Modul_01_RESETBOX.md"},
  {no:"02", label:"WATER",    ring:"inner", file:"MODULES/Modul_02_WATER.md"},
  {no:"03", label:"SHELTER",  ring:"inner", file:"MODULES/Modul_03_SHELTER.md"},
  {no:"04", label:"FOOD",     ring:"inner", file:"MODULES/Modul_04_FOOD.md"},
  {no:"05", label:"SLEEP",    ring:"inner", file:"MODULES/Modul_05_SLEEP.md"},
  {no:"06", label:"BODY",     ring:"inner", file:"MODULES/Modul_06_BODY.md"},
  {no:"07", label:"PSYCHE",   ring:"inner", file:"MODULES/Modul_07_PSYCHE.md"},
  {no:"08", label:"DEVICE",   ring:"inner", file:"MODULES/Modul_08_DEVICE.md"},
  {no:"09", label:"DEBT",     ring:"inner", file:"MODULES/Modul_09_DEBT.md"}
];
const LINKS = {
  "01":["02","03","09"],
  "02":["04","06","13"], // 13 liegt außerhalb – für Preview ignorieren
  "03":["05","01"],
  "04":["02","05"],
  "05":["03","07","06"],
  "06":["02","05","07"],
  "07":["05","06"],
  "08":["01"],
  "09":["01","10"]       // 10 liegt außerhalb – für Preview ignorieren
};

/* --- Setup --- */
const svg = document.getElementById('ringmap');
const edgesLayer = document.getElementById('edges');
const tip = document.getElementById('tip');

const inner = MODS.filter(m=>m.ring==="inner");
const pos = { "01": {x:0, y:0} };
const RING_R = 220, OFFSET = 8;
const radius = RING_R + OFFSET;

/* --- Platzieren --- */
(function(){
  const step = (Math.PI*2)/inner.length, start=-Math.PI/2;
  inner.forEach((m,idx)=>{
    const a = start + idx*step;
    const x = Math.cos(a)*radius, y = Math.sin(a)*radius;
    pos[m.no] = {x,y};

    const url = "module.html?file="+encodeURIComponent(m.file);
    const A = ns('a'); A.setAttributeNS(xlink,'xlink:href',url); A.setAttribute('href',url); A.classList.add('node-anchor');
    const g = ns('g'); g.setAttribute('class','node inner'); g.setAttribute('transform',`translate(${x},${y})`);
    g.setAttribute('tabindex','0'); g.dataset.id = m.no; g.setAttribute('aria-label',`${m.no} ${m.label}`);

    const r = 68;
    const cut = ns('circle'); cut.setAttribute('class','cut'); cut.setAttribute('r',r);
    const rim = ns('circle'); rim.setAttribute('class','rim'); rim.setAttribute('r',r);
    const hit = ns('circle'); hit.setAttribute('class','hit'); hit.setAttribute('r',r);
    const t = ns('text'); t.textContent = `${m.no} ${m.label}`;

    g.append(cut,rim,hit,t); A.appendChild(g); svg.appendChild(A);
    fitLabel(t, r);
  });
})();

/* --- Kanten zeichnen (nur wenn beide Enden in pos) --- */
(function(){
  const done = {};
  Object.keys(LINKS).forEach(a=>{
    LINKS[a].forEach(b=>{
      if(!pos[a] || !pos[b]) return;             // ignoriere Verweise nach außen
      const key = (a<b)?`${a}-${b}`:`${b}-${a}`;
      if(done[key]) return; done[key]=1;
      const A=pos[a], B=pos[b], mx=(A.x+B.x)/2, my=(A.y+B.y)/2, k=0.12, nx=(B.y-A.y), ny=-(B.x-A.x);
      const cx=mx+nx*k, cy=my+ny*k;
      const p = ns('path'); p.setAttribute('d',`M ${A.x} ${A.y} Q ${cx} ${cy} ${B.x} ${B.y}`);
      p.setAttribute('data-a',a); p.setAttribute('data-b',b); edgesLayer.appendChild(p);
    });
  });
})();

/* --- Hover/Fokus Logik --- */
let active = null;
function highlight(no,on){ edgesLayer.querySelectorAll(`path[data-a="${no}"],path[data-b="${no}"]`).forEach(p=>p.classList.toggle('on',!!on)); }
function setActive(id, evt){
  if(active===id){ if(evt) showTip(id, evt); return; }
  if(active){
    document.querySelector(`g.node[data-id="${active}"]`)?.classList.remove('active');
    highlight(active,false);
  }
  active=id;
  if(id){
    document.querySelector(`g.node[data-id="${id}"]`)?.classList.add('active');
    highlight(id,true);
    if(evt) showTip(id,evt);
  }else hideTip();
}
function showTip(id, e){
  const m = MODS.find(x=>x.no===id); const text = m?`${m.no} ${m.label}`:(id||'');
  tip.textContent = text; tip.style.left=(e.clientX)+'px'; tip.style.top=(e.clientY)+'px'; tip.classList.add('show');
}
function hideTip(){ tip.classList.remove('show'); }
function ns(tag){ return document.createElementNS('http://www.w3.org/2000/svg', tag); }
const xlink = 'http://www.w3.org/1999/xlink';

function fitLabel(textEl, R){
  let fs = 32; textEl.setAttribute('font-size',fs);
  let bb; try { bb = textEl.getBBox(); } catch { return; }
  const maxW = 1.65 * R;
  while (bb && bb.width > maxW && fs > 16){
    fs -= 1; textEl.setAttribute('font-size',fs);
    try { bb = textEl.getBBox(); } catch { break; }
  }
}

/* Bindings */
(function(){
  // mittlere Resetbox: Hover zeigt Links 01↔(02,03,09)
  const center = document.querySelector('g.center');
  ['pointerenter','mouseenter'].forEach(ev=>center.addEventListener(ev,(e)=>setActive('01',e)));
  ['pointerleave','mouseleave','focusout'].forEach(ev=>center.addEventListener(ev,()=>setActive(null)));
  center.addEventListener('pointermove', (e)=>showTip('01',e));

  document.querySelectorAll('a.node-anchor').forEach(a=>{
    const g = a.querySelector('[data-id]'); if(!g) return; const id=g.dataset.id;
    const enter = e=>setActive(id,e), move=e=>showTip(id,e), leave=()=>setActive(null);
    a.addEventListener('pointerenter', enter); a.addEventListener('mouseenter', enter);
    a.addEventListener('pointermove',  move);  a.addEventListener('mousemove',  move);
    a.addEventListener('pointerleave', leave); a.addEventListener('mouseleave', leave);
    g.addEventListener('focusin', e=>setActive(id,e)); g.addEventListener('focusout', ()=>setActive(null));
    // Touch: 1. Tap zeigt Verbindungen, 2. Tap öffnet
    a.addEventListener('click', (e)=>{ if(active!==id){ setActive(id,e); e.preventDefault(); } }, {capture:true});
  });

  const svg = document.getElementById('ringmap');
  svg.addEventListener('pointerleave', ()=>setActive(null));
  svg.addEventListener('mouseleave',   ()=>setActive(null));
})();
</script>
</body>
</html>
