<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUESTSYSTEM · Modul-Karte (v2)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
  <a href="./">← QUESTSYSTEM</a>
  <div class="legend">
    <span class="pill"><span class="swatch red"></span>Existential</span>
    <span class="pill"><span class="swatch yellow"></span>Societal</span>
    <span class="pill"><span class="swatch blue"></span>Structural</span>
  </div>
  <div class="hint">Maus/Trackpad: scrollen = Zoom, ziehen = Pan, <kbd>Doppelklick</kbd> = Reset. Mobile: Pinch-Zoom & Drag, Doppeltipp = Reset. Hover/Tippen zeigt Verknüpfungen. Klick öffnet Details.</div>
  <div class="toolbar">
    <button class="btn" id="fitBtn">Auf Bildschirm zentrieren</button>
    <button class="btn" id="resetBtn">Zoom/Position zurücksetzen</button>
    <button class="btn" id="toggleEdgesBtn">Alle Verbindungen anzeigen/aus</button>
  </div>
</header>

<div class="wrap">
  <div class="board">
    <!-- WICHTIG: xmlns:xlink ergänzt -->
    <svg viewBox="0 0 1000 1000" role="img" aria-labelledby="title desc"
         xmlns:xlink="http://www.w3.org/1999/xlink">
      <title id="title">QUESTSYSTEM – Modul-Karte</title>
      <desc id="desc">42 Module in drei Ringen. Hover/Tippen zeigt Verbindungen. Klick öffnet die Modul-Datei.</desc>

      <g id="viewport">
        <g class="grid-circ">
          <circle cx="500" cy="500" r="160"></circle>
          <circle cx="500" cy="500" r="260"></circle>
          <circle cx="500" cy="500" r="360"></circle>
          <circle cx="500" cy="500" r="460"></circle>
        </g>

        <circle class="ring" cx="500" cy="500" r="220"></circle>
        <circle class="ring" cx="500" cy="500" r="320"></circle>
        <circle class="ring" cx="500" cy="500" r="420"></circle>

        <g id="edges"></g>
        <g id="nodes"></g>
      </g>
    </svg>
  </div>
</div>

<footer>
  © QUESTSYSTEM · Lizenz: CC BY-SA 4.0 + Dignity Clause · Version: map.html v2 (link-fix)
</footer>

<script>
/* ===== Daten ===== */
const MODULES = [
  {id:1,key:'RESETBOX',ring:'red'},{id:2,key:'WATER',ring:'red'},{id:3,key:'SHELTER',ring:'red'},
  {id:4,key:'FOOD',ring:'red'},{id:5,key:'SLEEP',ring:'red'},{id:6,key:'BODY',ring:'red'},
  {id:7,key:'PSYCH',ring:'red'},{id:8,key:'DEVICE',ring:'red'},{id:9,key:'DEBT',ring:'red'},
  {id:10,key:'WORK',ring:'yellow'},{id:11,key:'SCHOOL',ring:'yellow'},{id:12,key:'BORDER',ring:'yellow'},
  {id:13,key:'NATURE',ring:'yellow'},{id:14,key:'HEALTH',ring:'yellow'},{id:15,key:'CARE',ring:'yellow'},
  {id:16,key:'FAMILY',ring:'yellow'},{id:17,key:'ANIMAL',ring:'yellow'},{id:18,key:'CULTURE',ring:'yellow'},
  {id:19,key:'MEDIA',ring:'yellow'},{id:20,key:'ENERGY',ring:'yellow'},{id:21,key:'CLIMATE',ring:'yellow'},
  {id:22,key:'MIGRATION',ring:'yellow'},{id:23,key:'JUSTICE',ring:'yellow'},{id:24,key:'COMMUNITY',ring:'yellow'},
  {id:25,key:'FINANCE',ring:'blue'},{id:26,key:'HOUSING',ring:'blue'},{id:27,key:'TRANSPORT',ring:'blue'},
  {id:28,key:'NETWORK',ring:'blue'},{id:29,key:'SYMBOL',ring:'blue'},{id:30,key:'TRUTH',ring:'blue'},
  {id:31,key:'MEMORY',ring:'blue'},{id:32,key:'LICENCE',ring:'blue'},{id:33,key:'PRIVACY',ring:'blue'},
  {id:34,key:'SECURITY',ring:'blue'},{id:35,key:'DATA',ring:'blue'},{id:36,key:'CONFLICT',ring:'blue'},
  {id:37,key:'DEMOCRACY',ring:'blue'},{id:38,key:'GOVERNANCE',ring:'blue'},{id:39,key:'KNOWLEDGE',ring:'blue'},
  {id:40,key:'ART',ring:'blue'},{id:41,key:'FUTURE',ring:'blue'},{id:42,key:'DEATH',ring:'blue'},
];
const FILE_NAME_OVERRIDES = { 7:'MODULES/Modul_07_PSYCH.md' };

const CONNECTIONS = {
  1:[2,3,9,20,28,30], 2:[4,6,13,1,20], 3:[5,13,1,26], 4:[2,13,25,1], 5:[3,7,6,14],
  6:[2,5,14,33], 7:[5,6,31,33,14], 8:[20,28,35,33,1], 9:[25,23,32,1],
  10:[25,23,28,38], 11:[30,39,28,31], 12:[23,22,38,33], 13:[2,3,4,21], 14:[6,7,23,33],
  15:[14,16,23,24], 16:[15,14,24,26], 17:[13,15,24,14], 18:[19,29,24,40], 19:[18,30,28,33],
  20:[8,28,2,25], 21:[13,20,28,37], 22:[12,23,24,33], 23:[9,10,12,30], 24:[15,16,17,28],
  25:[9,10,20,26], 26:[3,16,25,24], 27:[28,26,25,21], 28:[8,19,20,24,21], 29:[18,30,40,24],
  30:[11,19,23,33,1], 31:[7,11,39,35], 32:[23,30,33,25], 33:[8,14,19,30,34], 34:[33,35,36,28],
  35:[8,31,33,39], 36:[34,23,37,38], 37:[21,36,38,30], 38:[10,12,36,37,30], 39:[11,31,35,30],
  40:[18,29,30,24], 41:[21,30,39,24], 42:[30,23,31,39],
};

/* ===== Layout ===== */
const center = {x:500, y:500};
const radii = { red:220, yellow:320, blue:420 };
const groups = {
  red:MODULES.filter(m=>m.ring==='red'),
  yellow:MODULES.filter(m=>m.ring==='yellow'),
  blue:MODULES.filter(m=>m.ring==='blue')
};
function place(group, r){
  const n = group.length, start = -Math.PI/2;
  return group.map((m,i)=>{
    const a = start + i*(2*Math.PI/n);
    return {...m, r, a, x:center.x + r*Math.cos(a), y:center.y + r*Math.sin(a)};
  });
}
const layout = [...place(groups.red,radii.red), ...place(groups.yellow,radii.yellow), ...place(groups.blue,radii.blue)];
const fillOf = ring => ring==='red'?'var(--red)':ring==='yellow'?'var(--yellow)':'var(--blue)';

/* ===== Render ===== */
const vp = document.getElementById('viewport');
const gEdges = document.getElementById('edges');
const gNodes = document.getElementById('nodes');

const nodeById = new Map(layout.map(m=>[m.id,m]));
const edges = [];
Object.entries(CONNECTIONS).forEach(([from,targets])=>{
  const a = nodeById.get(+from);
  (targets||[]).forEach(t=>{
    const b = nodeById.get(+t); if(!a||!b) return;
    const e = document.createElementNS('http://www.w3.org/2000/svg','line');
    e.setAttribute('x1',a.x); e.setAttribute('y1',a.y);
    e.setAttribute('x2',b.x); e.setAttribute('y2',b.y);
    e.setAttribute('class','edge'); gEdges.appendChild(e);
    edges.push({a:a.id,b:b.id,el:e});
  });
});

function toggleEdgesFor(id,on){ edges.forEach(({a,b,el})=>{ if(a===id||b===id) el.classList.toggle('on',!!on); }); }
let showAllEdges=false;
function setAllEdges(on){ showAllEdges=!!on; edges.forEach(e=>e.el.classList.toggle('on',showAllEdges)); }

function linkFor(m){
  const ov = FILE_NAME_OVERRIDES[m.id];
  const file = ov ?? `MODULES/Modul_${String(m.id).padStart(2,'0')}_${m.key}.md`;
  return `module.html?file=${encodeURIComponent(file)}`;
}

layout.forEach(m=>{
  // <a> im SVG: beide href-Varianten setzen (SVG2 & xlink)
  const a = document.createElementNS('http://www.w3.org/2000/svg','a');
  a.setAttributeNS(null, 'href', linkFor(m)); // SVG2
  a.setAttributeNS('http://www.w3.org/1999/xlink', 'href', linkFor(m)); // xlink Fallback
  a.setAttribute('target','_self');

  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('class','node');
  g.setAttribute('transform',`translate(${m.x},${m.y})`);
  g.addEventListener('mouseenter',()=>!showAllEdges && toggleEdgesFor(m.id,true));
  g.addEventListener('mouseleave',()=>!showAllEdges && toggleEdgesFor(m.id,false));
  g.addEventListener('touchstart',ev=>{ ev.preventDefault(); if(!showAllEdges){ g._on=!g._on; toggleEdgesFor(m.id,g._on); } });

  const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('r',9); dot.setAttribute('class','dot'); dot.setAttribute('fill', fillOf(m.ring));
  g.appendChild(dot);

  const bg = document.createElementNS('http://www.w3.org/2000/svg','text');
  bg.setAttribute('y',-14); bg.setAttribute('class','label bg'); bg.textContent = `${String(m.id).padStart(2,'0')} ${m.key}`;
  const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
  tx.setAttribute('y',-14); tx.setAttribute('class','label'); tx.textContent = `${String(m.id).padStart(2,'0')} ${m.key}`;
  g.appendChild(bg); g.appendChild(tx);

  g.setAttribute('tabindex','0');
  g.addEventListener('focus', ()=>!showAllEdges && toggleEdgesFor(m.id,true));
  g.addEventListener('blur',  ()=>!showAllEdges && toggleEdgesFor(m.id,false));

  a.appendChild(g); gNodes.appendChild(a);
});

/* ===== Pan & Zoom ===== */
let state = {k:1,x:0,y:0};
const svg = document.querySelector('svg');
function applyTransform(){ vp.setAttribute('transform',`translate(${state.x},${state.y}) scale(${state.k})`); }
function screenToSvg(pt){ const ctm = svg.getScreenCTM(); return {x:(pt.x-ctm.e)/ctm.a, y:(pt.y-ctm.f)/ctm.d}; }

let dragging=false, dragStart={x:0,y:0}, startState={x:0,y:0};
svg.addEventListener('mousedown', e=>{ dragging=true; dragStart={x:e.clientX,y:e.clientY}; startState={...state}; });
window.addEventListener('mousemove', e=>{ if(!dragging) return; state.x=startState.x+(e.clientX-dragStart.x); state.y=startState.y+(e.clientY-dragStart.y); applyTransform(); });
window.addEventListener('mouseup', ()=> dragging=false);

svg.addEventListener('touchstart', e=>{ if(e.touches.length===1){ dragging=true; dragStart={x:e.touches[0].clientX,y:e.touches[0].clientY}; startState={...state}; } }, {passive:false});
svg.addEventListener('touchmove', e=>{ if(dragging && e.touches.length===1){ state.x=startState.x+(e.touches[0].clientX-dragStart.x); state.y=startState.y+(e.touches[0].clientY-dragStart.y); applyTransform(); } }, {passive:false});
svg.addEventListener('touchend', ()=> dragging=false);

svg.addEventListener('wheel', e=>{
  e.preventDefault();
  const delta = Math.sign(e.deltaY) * -0.1;
  const newK = Math.min(3.2, Math.max(0.5, state.k + delta));
  const pt = screenToSvg({x:e.clientX,y:e.clientY});
  state.x = pt.x - (pt.x - state.x) * (newK/state.k);
  state.y = pt.y - (pt.y - state.y) * (newK/state.k);
  state.k = newK; applyTransform();
},{passive:false});

let lastTap=0;
svg.addEventListener('dblclick', ()=>reset());
svg.addEventListener('touchend', e=>{ const now=Date.now(); if(now-lastTap<300){ reset(); } lastTap=now; });

function fit(){ state={k:0.92,x:40,y:40}; applyTransform(); }
function reset(){ state={k:1,x:0,y:0}; applyTransform(); }
document.getElementById('fitBtn').addEventListener('click', fit);
document.getElementById('resetBtn').addEventListener('click', reset);
document.getElementById('toggleEdgesBtn').addEventListener('click', ()=> setAllEdges(!showAllEdges));
fit();
</script>

<noscript>
  <div style="max-width:1200px;margin:12px auto;color:#fff;opacity:.85;padding:0 16px">
    <strong>Hinweis:</strong> Für die interaktive Modul-Karte wird JavaScript benötigt.
  </div>
</noscript>
</body>
</html>
