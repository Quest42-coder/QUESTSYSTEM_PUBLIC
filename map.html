<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUESTSYSTEM · Modul-Karte (v2 – core+linkfix)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
  <a href="./">← QUESTSYSTEM</a>
  <div class="legend">
    <span class="pill"><span class="swatch red"></span>Existential</span>
    <span class="pill"><span class="swatch yellow"></span>Societal</span>
    <span class="pill"><span class="swatch blue"></span>Structural</span>
  </div>
  <div class="hint">Scroll = Zoom, Drag = Pan, Doppelklick = Reset. Hover/Tippen zeigt Verknüpfungen. Klick öffnet Details.</div>
  <div class="toolbar">
    <button class="btn" id="fitBtn">Auf Bildschirm zentrieren</button>
    <button class="btn" id="resetBtn">Zoom/Position zurücksetzen</button>
    <button class="btn" id="toggleEdgesBtn">Alle Verbindungen anzeigen/aus</button>
  </div>
</header>

<div class="wrap">
  <div class="board">
    <!-- Wichtig: xlink-Namespace setzen -->
    <svg viewBox="0 0 1000 1000" role="img" aria-labelledby="title desc"
         xmlns:xlink="http://www.w3.org/1999/xlink">
      <title id="title">QUESTSYSTEM – Modul-Karte</title>
      <desc id="desc">RESETBOX im Kern. 42 Module in drei Ringen. Klick öffnet die Modul-Datei.</desc>

      <g id="viewport">
        <!-- Hilfsringe -->
        <g class="grid-circ">
          <circle cx="500" cy="500" r="140"></circle>
          <circle cx="500" cy="500" r="240"></circle>
          <circle cx="500" cy="500" r="340"></circle>
          <circle cx="500" cy="500" r="440"></circle>
        </g>

        <!-- Ringe -->
        <circle class="ring" cx="500" cy="500" r="240"></circle>
        <circle class="ring" cx="500" cy="500" r="340"></circle>
        <circle class="ring" cx="500" cy="500" r="440"></circle>

        <!-- Kern-Halo für RESETBOX -->
        <circle cx="500" cy="500" r="70" class="fill-red" opacity="0.08"></circle>

        <g id="edges"></g>
        <g id="nodes"></g>
      </g>
    </svg>
  </div>
</div>

<footer>
  © QUESTSYSTEM · Lizenz: CC BY-SA 4.0 + Dignity Clause · Version: map.html v2 core+linkfix
</footer>

<script>
<script>
/* ===== Daten ===== */
const MODULES = [
  // Existential
  {id:1,key:'RESETBOX',ring:'red'},
  {id:2,key:'WATER',ring:'red'},{id:3,key:'SHELTER',ring:'red'},{id:4,key:'FOOD',ring:'red'},
  {id:5,key:'SLEEP',ring:'red'},{id:6,key:'BODY',ring:'red'},{id:7,key:'PSYCHE',ring:'red'},
  {id:8,key:'DEVICE',ring:'red'},{id:9,key:'DEBT',ring:'red'},
  // Societal
  {id:10,key:'WORK',ring:'yellow'},{id:11,key:'SCHOOL',ring:'yellow'},{id:12,key:'BORDER',ring:'yellow'},
  {id:13,key:'NATURE',ring:'yellow'},{id:14,key:'HEALTH',ring:'yellow'},{id:15,key:'CARE',ring:'yellow'},
  {id:16,key:'FAMILY',ring:'yellow'},{id:17,key:'ANIMAL',ring:'yellow'},{id:18,key:'CULTURE',ring:'yellow'},
  {id:19,key:'MEDIA',ring:'yellow'},{id:20,key:'ENERGY',ring:'yellow'},{id:21,key:'CLIMATE',ring:'yellow'},
  {id:22,key:'MIGRATION',ring:'yellow'},{id:23,key:'JUSTICE',ring:'yellow'},{id:24,key:'COMMUNITY',ring:'yellow'},
  // Structural
  {id:25,key:'FINANCE',ring:'blue'},{id:26,key:'HOUSING',ring:'blue'},{id:27,key:'TRANSPORT',ring:'blue'},
  {id:28,key:'NETWORK',ring:'blue'},{id:29,key:'SYMBOL',ring:'blue'},{id:30,key:'TRUTH',ring:'blue'},
  {id:31,key:'MEMORY',ring:'blue'},{id:32,key:'LICENCE',ring:'blue'},{id:33,key:'PRIVACY',ring:'blue'},
  {id:34,key:'SECURITY',ring:'blue'},{id:35,key:'DATA',ring:'blue'},{id:36,key:'CONFLICT',ring:'blue'},
  {id:37,key:'DEMOCRACY',ring:'blue'},{id:38,key:'GOVERNANCE',ring:'blue'},{id:39,key:'KNOWLEDGE',ring:'blue'},
  {id:40,key:'ART',ring:'blue'},{id:41,key:'FUTURE',ring:'blue'},{id:42,key:'DEATH',ring:'blue'},
];

/* Dateinamen-Overrides – ergänze hier, wenn deine Datei anders heißt */
const FILE_NAME_OVERRIDES = {
  7: 'MODULES/Modul_07_PSYCHE.md'
  // Beispiel: 18: 'MODULES/Modul_18_KULTUR.md'
};

/* ===== Kern-Verknüpfungen (1:1 aus deiner Tabelle) ===== */
const CONNECTIONS = {
  // Existential (01–09)
  1:[2,3,9],            // RESETBOX → WATER, SHELTER, DEBT
  2:[4,6,13],           // WATER → FOOD, BODY, NATURE
  3:[5,13,1],           // SHELTER → SLEEP, NATURE, RESETBOX
  4:[2,13,25],          // FOOD → WATER, NATURE, FINANCE
  5:[3,7,6],            // SLEEP → SHELTER, PSYCHE, BODY
  6:[2,5,7],            // BODY → WATER, SLEEP, PSYCHE
  7:[5,6,30],           // PSYCHE → SLEEP, BODY, TRUTH
  8:[20,32,1],          // DEVICE → ENERGY, LICENCE, RESETBOX
  9:[10,25,1],          // DEBT → WORK, FINANCE, RESETBOX

  // Societal (10–24)
  10:[9,11,25],         // WORK → DEBT, SCHOOL, FINANCE
  11:[10,30,7],         // SCHOOL → WORK, TRUTH, PSYCHE
  12:[1,13,36],         // BORDER → RESETBOX, NATURE, CONFLICT
  13:[2,4,20],          // NATURE → WATER, FOOD, ENERGY
  14:[2,6,7],           // HEALTH → WATER, BODY, PSYCHE
  15:[14,7,1],          // CARE → HEALTH, PSYCHE, RESETBOX
  16:[5,11,14],         // FAMILY → SLEEP, SCHOOL, HEALTH
  17:[4,13,14],         // ANIMAL → FOOD, NATURE, HEALTH
  18:[11,30,29],        // CULTURE → SCHOOL, TRUTH, SYMBOL
  19:[30,32,11],        // MEDIA → TRUTH, LICENCE, SCHOOL
  20:[8,13,25],         // ENERGY → DEVICE, NATURE, FINANCE
  21:[13,20,14],        // CLIMATE → NATURE, ENERGY, HEALTH
  22:[12,13,36],        // MIGRATION → BORDER, NATURE, CONFLICT
  23:[9,10,32],         // JUSTICE → DEBT, WORK, LICENCE
  24:[11,18,23],        // COMMUNITY → SCHOOL, CULTURE, JUSTICE

  // Structural (25–42)
  25:[9,10,20],         // FINANCE → DEBT, WORK, ENERGY
  26:[3,5,25],          // HOUSING → SHELTER, SLEEP, FINANCE
  27:[2,20,22],         // TRANSPORT → WATER, ENERGY, MIGRATION
  28:[8,20,19],         // NETWORK → DEVICE, ENERGY, MEDIA
  29:[18,24,30],        // SYMBOL → CULTURE, COMMUNITY, TRUTH
  30:[11,19,32],        // TRUTH → SCHOOL, MEDIA, LICENCE
  31:[11,29,30],        // MEMORY → SCHOOL, SYMBOL, TRUTH
  32:[19,30,8],         // LICENCE → MEDIA, TRUTH, DEVICE
  33:[8,19,32],         // PRIVACY → DEVICE, MEDIA, LICENCE
  34:[1,12,36],         // SECURITY → RESETBOX, BORDER, CONFLICT
  35:[8,28,32],         // DATA → DEVICE, NETWORK, LICENCE
  36:[12,22,34],        // CONFLICT → BORDER, MIGRATION, SECURITY
  37:[23,24,25],        // DEMOCRACY → JUSTICE, COMMUNITY, FINANCE
  38:[23,37,25],        // GOVERNANCE → JUSTICE, DEMOCRACY, FINANCE
  39:[11,30,31],        // KNOWLEDGE → SCHOOL, TRUTH, MEMORY
  40:[18,29,39],        // ART → CULTURE, SYMBOL, KNOWLEDGE
  41:[21,39,40],        // FUTURE → CLIMATE, KNOWLEDGE, ART
  42:[14,15,41],        // DEATH → HEALTH, CARE, FUTURE
};

/* ===== Layout (RESETBOX im Kern) ===== */
const center = {x:500, y:500};
const radii  = { inner:260, middle:360, outer:460 }; // Ringe außen, Kern frei

const groups = {
  red:   MODULES.filter(m=>m.ring==='red' && m.id!==1),   // alle roten außer RESETBOX
  yellow:MODULES.filter(m=>m.ring==='yellow'),
  blue:  MODULES.filter(m=>m.ring==='blue')
};

function place(group, r){
  const n = group.length, start = -Math.PI/2;
  return group.map((m,i)=>{
    const a = start + i*(2*Math.PI/n);
    return {...m, r, a, x:center.x + r*Math.cos(a), y:center.y + r*Math.sin(a)};
  });
}
const layout = [
  {id:1,key:'RESETBOX',ring:'red',x:center.x,y:center.y,r:0,a:0,core:true},
  ...place(groups.red,   radii.inner),
  ...place(groups.yellow,radii.middle),
  ...place(groups.blue,  radii.outer)
];

const fillOf = ring => ring==='red'?'var(--red)': ring==='yellow'?'var(--yellow)':'var(--blue)';

/* ===== Render (inkl. robuster Link-Klick) ===== */
const vp     = document.getElementById('viewport');
const gEdges = document.getElementById('edges');
const gNodes = document.getElementById('nodes');

const nodeById = new Map(layout.map(m=>[m.id,m]));
const edges = [];
Object.entries(CONNECTIONS).forEach(([from,targets])=>{
  const a = nodeById.get(+from);
  (targets||[]).forEach(t=>{
    const b = nodeById.get(+t); if(!a||!b) return;
    const e = document.createElementNS('http://www.w3.org/2000/svg','line');
    e.setAttribute('x1',a.x); e.setAttribute('y1',a.y);
    e.setAttribute('x2',b.x); e.setAttribute('y2',b.y);
    e.setAttribute('class','edge'); gEdges.appendChild(e);
    edges.push({a:a.id,b:b.id,el:e});
  });
});

function toggleEdgesFor(id,on){ edges.forEach(({a,b,el})=>{ if(a===id||b===id) el.classList.toggle('on',!!on); }); }
let showAllEdges=false;
function setAllEdges(on){ showAllEdges=!!on; edges.forEach(e=>e.el.classList.toggle('on',showAllEdges)); }

function fileFor(m){
  const ov = FILE_NAME_OVERRIDES[m.id];
  return ov ?? `MODULES/Modul_${String(m.id).padStart(2,'0')}_${m.key}.md`;
}
function linkFor(m){ return `module.html?file=${encodeURIComponent(fileFor(m))}`; }

// Nodes + Labels + Klickverhalten
layout.forEach(m=>{
  const link = linkFor(m);

  // <a> (SVG) + robuster Click-Handler
  const a = document.createElementNS('http://www.w3.org/2000/svg','a');
  a.setAttributeNS(null,'href',link);
  a.setAttributeNS('http://www.w3.org/1999/xlink','href',link);
  a.setAttribute('target','_self');

  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('class','node');
  g.setAttribute('transform',`translate(${m.x},${m.y})`);
  g.style.cursor = 'pointer';
  g.addEventListener('click', (ev)=>{ ev.preventDefault(); window.location.assign(link); });

  g.addEventListener('mouseenter',()=>!showAllEdges && toggleEdgesFor(m.id,true));
  g.addEventListener('mouseleave',()=>!showAllEdges && toggleEdgesFor(m.id,false));
  g.addEventListener('touchstart',ev=>{ ev.preventDefault(); if(!showAllEdges){ g._on=!g._on; toggleEdgesFor(m.id,g._on); } });

  const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('r', m.core ? 14 : 9);
  dot.setAttribute('class','dot');
  dot.setAttribute('fill', fillOf(m.ring));
  g.appendChild(dot);

  const bg = document.createElementNS('http://www.w3.org/2000/svg','text');
  bg.setAttribute('y', m.core ? -22 : -14);
  bg.setAttribute('class','label bg');
  bg.textContent = `${String(m.id).padStart(2,'0')} ${m.key}`;
  const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
  tx.setAttribute('y', m.core ? -22 : -14);
  tx.setAttribute('class','label');
  tx.textContent = `${String(m.id).padStart(2,'0')} ${m.key}`;
  g.appendChild(bg); g.appendChild(tx);

  g.setAttribute('tabindex','0'); g.setAttribute('role','link');
  g.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); window.location.assign(link); } });
  g.addEventListener('focus', ()=>!showAllEdges && toggleEdgesFor(m.id,true));
  g.addEventListener('blur',  ()=>!showAllEdges && toggleEdgesFor(m.id,false));

  a.appendChild(g); gNodes.appendChild(a);
});

/* ===== Pan & Zoom (wie gehabt) ===== */
let state = {k:1,x:0,y:0};
const svg = document.querySelector('svg');
function applyTransform(){ vp.setAttribute('transform',`translate(${state.x},${state.y}) scale(${state.k})`); }
function screenToSvg(pt){ const ctm = svg.getScreenCTM(); return {x:(pt.x-ctm.e)/ctm.a, y:(pt.y-ctm.f)/ctm.d}; }
let dragging=false, dragStart={x:0,y:0}, startState={x:0,y:0};
svg.addEventListener('mousedown', e=>{ dragging=true; dragStart={x:e.clientX,y:e.clientY}; startState={...state}; });
window.addEventListener('mousemove', e=>{ if(!dragging) return; state.x=startState.x+(e.clientX-dragStart.x); state.y=startState.y+(e.clientY-dragStart.y); applyTransform(); });
window.addEventListener('mouseup', ()=> dragging=false);
svg.addEventListener('touchstart', e=>{ if(e.touches.length===1){ dragging=true; dragStart={x:e.touches[0].clientX,y:e.touches[0].clientY}; startState={...state}; } }, {passive:false});
svg.addEventListener('touchmove', e=>{ if(dragging && e.touches.length===1){ state.x=startState.x+(e.touches[0].clientX-dragStart.x); state.y=startState.y+(e.touches[0].clientY-dragStart.y); applyTransform(); } }, {passive:false});
svg.addEventListener('touchend', ()=> dragging=false);
svg.addEventListener('wheel', e=>{
  e.preventDefault();
  const delta = Math.sign(e.deltaY) * -0.1;
  const newK = Math.min(3.2, Math.max(0.5, state.k + delta));
  const pt = screenToSvg({x:e.clientX,y:e.clientY});
  state.x = pt.x - (pt.x - state.x) * (newK/state.k);
  state.y = pt.y - (pt.y - state.y) * (newK/state.k);
  state.k = newK; applyTransform();
},{passive:false});
let lastTap=0;
svg.addEventListener('dblclick', ()=>reset());
svg.addEventListener('touchend', e=>{ const now=Date.now(); if(now-lastTap<300){ reset(); } lastTap=now; });
function fit(){ state={k:0.92,x:40,y:40}; applyTransform(); }
function reset(){ state={k:1,x:0,y:0}; applyTransform(); }
document.getElementById('fitBtn').addEventListener('click', fit);
document.getElementById('resetBtn').addEventListener('click', reset);
document.getElementById('toggleEdgesBtn').addEventListener('click', ()=> setAllEdges(!showAllEdges));
fit();
</script>
</script>

<noscript>
  <div style="max-width:1200px;margin:12px auto;color:#fff;opacity:.85;padding:0 16px">
    <strong>Hinweis:</strong> Für die interaktive Modul-Karte wird JavaScript benötigt.
  </div>
</noscript>
</body>
</html>
